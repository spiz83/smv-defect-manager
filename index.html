<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Defect Tracker</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f2f7;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --border-color: #e5e5ea;
            --input-bg: #ffffff;
            --card-bg: #ffffff;
            --blue: #007AFF;
        }

        body.dark-mode {
            --bg-primary: #1c1c1e;
            --bg-secondary: #000000;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --border-color: #38383a;
            --input-bg: #2c2c2e;
            --card-bg: #2c2c2e;
            --blue: #0a84ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.4;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--bg-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }

        /* Header Styles */
        .app-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            flex: 1;
            color: var(--text-primary);
        }

        .back-link {
            color: var(--blue);
            font-size: 17px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-link:before {
            content: '‹';
            font-size: 28px;
            font-weight: 300;
        }

        /* Home Screen Styles */
        .home-container {
            padding: 20px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            color: var(--text-primary);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .search-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .search-label {
            font-size: 17px;
            min-width: 100px;
            color: var(--text-primary);
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            gap: 10px;
        }

        input[type="text"], select {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #c6c6c8;
            border-radius: 10px;
            font-size: 17px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--blue);
            color: var(--text-primary);
        }

        .search-btn {
            width: 44px;
            height: 44px;
            background: transparent;
            border: none;
            color: var(--blue);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .multi-select-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .multi-select-wrapper input {
            flex: 1;
        }

        .multi-select-wrapper .autocomplete-container {
            position: relative;
            flex: 1;
        }

        .multi-select-wrapper .autocomplete-dropdown {
            right: 0;
        }

        /* Manage Button */
        .manage-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            margin-top: 30px;
            border-top: 1px solid #e5e5ea;
        }

        .manage-link {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--blue);
            font-size: 17px;
            text-decoration: none;
            font-weight: 500;
        }

        .view-all-link {
            color: var(--blue);
            font-size: 17px;
            text-decoration: none;
        }

        /* View Defects Screen */
        .defects-container {
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        .defects-header {
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .lot-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .toolbar {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--blue);
            cursor: pointer;
            font-size: 28px;
            padding: 0;
        }

        .contractor-section {
            background: var(--bg-primary);
            margin-top: 20px;
            padding: 20px;
        }

        .contractor-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .defect-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .defect-item:last-child {
            border-bottom: none;
        }

        .defect-text {
            flex: 1;
            font-size: 17px;
            padding-left: 10px;
        }

        .defect-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid #007AFF;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 14px;
            padding: 20px;
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-secondary {
            background: #e5e5ea;
            color: var(--text-primary);
        }

        .btn-danger {
            background: #FF3B30;
            color: white;
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 15px;
            margin-bottom: 8px;
            color: #8e8e93;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #c6c6c8;
            border-radius: 10px;
            font-size: 17px;
        }

        /* Autocomplete Dropdown */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 54px;
            background: var(--bg-primary);
            border: 1px solid #c6c6c8;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 15px;
            font-size: 17px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item:active {
            background: var(--bg-secondary);
        }

        .autocomplete-item.highlighted {
            background: #e5e5ea;
        }

        /* Add Defects Form */
        .defect-form {
            padding: 20px;
        }

        .contractor-group {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .defect-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .defect-input-row span {
            font-size: 17px;
        }

        .defect-input-row input {
            flex: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            font-size: 15px;
        }

        .toast.error {
            background: #FF3B30;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Manage Screen */
        .manage-container {
            padding: 20px;
        }

        .import-section {
            background: var(--bg-primary);
            border: 2px dashed #c6c6c8;
            padding: 40px 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
        }

        .import-section:active {
            background: var(--bg-secondary);
        }

        .crud-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .crud-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
            padding: 15px 20px;
            border-radius: 10px;
        }

        .crud-item-label {
            font-size: 17px;
            font-weight: 600;
        }

        .crud-actions {
            display: flex;
            gap: 10px;
        }

        .crud-actions .btn {
            padding: 8px 16px;
            font-size: 15px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Database Manager - Handles all data operations
        class DatabaseManager {
            constructor() {
                this.data = {
                    addresses: [],
                    contractors: [],
                    trades: [],
                    defects: []
                };
                this.loadFromStorage();
                this.initializeSampleData();
            }

            loadFromStorage() {
                const stored = localStorage.getItem('defectTrackerDB');
                if (stored) {
                    this.data = JSON.parse(stored);
                }
            }

            save() {
                localStorage.setItem('defectTrackerDB', JSON.stringify(this.data));
            }

            initializeSampleData() {
                if (this.data.addresses.length === 0) {
                    // Comprehensive Trades List with Codes
                    this.data.trades = [
                        // BASE
                        { id: 1, name: 'Site Security & Waste Management', code: '060' },
                        { id: 2, name: 'Site Cut & Fill', code: '070' },
                        { id: 3, name: 'Retaining Walls – Site Prep', code: '072' },
                        { id: 4, name: 'Site Facilities - Hire Equipment', code: '080' },
                        { id: 5, name: 'Silt Fence & Temporary Driveway', code: '090' },
                        { id: 6, name: 'Set Out', code: '100' },
                        { id: 7, name: 'Electrical Mains', code: '110' },
                        { id: 8, name: 'Sewer & Water Supply Costs', code: '119' },
                        { id: 9, name: 'Sewerage & Stormwater Drains', code: '120' },
                        { id: 10, name: 'Spoil Removal – Drains', code: '121' },
                        { id: 11, name: 'Rock Breakout and Removal', code: '130' },
                        { id: 12, name: 'Screw Pile Set Out', code: '144' },
                        { id: 13, name: 'Piers & Screw Piles - Labour & Materials', code: '145' },
                        { id: 14, name: 'Concrete Slabs & Footings', code: '150' },
                        { id: 15, name: 'Termite Proofing - Slab Penetrations', code: '160' },
                        { id: 16, name: 'Concrete Pump', code: '170' },
                        { id: 17, name: 'Concrete Cure', code: '180' },
                        // FRAME
                        { id: 18, name: 'Site Grade Back - Post Slab', code: '190' },
                        { id: 19, name: 'Pre-Fab Wall Frames & Roof Truss', code: '200' },
                        { id: 20, name: '2-Plank Walkway', code: '204' },
                        { id: 21, name: 'Perimeter Guardrail', code: '205' },
                        { id: 22, name: 'Windows & Entry Frames', code: '210' },
                        { id: 23, name: 'Structural Steel', code: '215' },
                        { id: 24, name: 'Framing Materials and Hardware', code: '218' },
                        { id: 25, name: 'Carpenter - Wall Frame & Roof Trusses', code: '220' },
                        { id: 26, name: 'Crane Hire', code: '222' },
                        { id: 27, name: 'Void Protection', code: '224' },
                        { id: 28, name: 'Party & Boundary Wall Systems', code: '225' },
                        { id: 29, name: 'Party Walls – Labour', code: '226' },
                        // LOCK UP
                        { id: 30, name: 'Metal Fascia & Gutters - Lab & Materials', code: '230' },
                        { id: 31, name: 'Site Cleaner - OH&S Clean', code: '240' },
                        { id: 32, name: 'Skylights', code: '248' },
                        { id: 33, name: 'Roof Tiles (Material & Labour)', code: '250' },
                        { id: 34, name: 'Sheet Roofing (Material & Labour)', code: '255' },
                        { id: 35, name: 'Foilwrap to External Walls', code: '260' },
                        { id: 36, name: 'Scaffolding', code: '265' },
                        { id: 37, name: 'Plumber (Material & Labour)', code: '270' },
                        { id: 38, name: 'Brick Sand', code: '280' },
                        { id: 39, name: 'Bricks', code: '290' },
                        { id: 40, name: 'Brick Hardware', code: '300' },
                        { id: 41, name: 'Bricklayer Labour', code: '310' },
                        { id: 42, name: 'Brick Lintels', code: '320' },
                        { id: 43, name: 'Box Gutter, Cappings, Flashings', code: '330' },
                        { id: 44, name: 'Physical Perimeter Termite Barrier', code: '340' },
                        { id: 45, name: 'Electrical (Material & Labour)', code: '350' },
                        { id: 46, name: 'Security & Data Systems', code: '370' },
                        { id: 47, name: 'Internal Lockup Materials', code: '390' },
                        { id: 48, name: 'Lock Up Hardware', code: '400' },
                        { id: 49, name: 'Carpenter - Internal Lock-Up', code: '420' },
                        { id: 50, name: 'External Wall Cladding Materials', code: '425' },
                        { id: 51, name: 'External Wall Cladding Labour', code: '426' },
                        // FIX
                        { id: 52, name: 'Insulation Batts to Walls', code: '430' },
                        { id: 53, name: 'Plaster Linings (Materials & Labour)', code: '440' },
                        { id: 54, name: 'Brick Cleaner', code: '450' },
                        { id: 55, name: 'Renderer & External Mouldings', code: '460' },
                        { id: 56, name: 'Staircase', code: '470' },
                        { id: 57, name: 'Feature Stone Cladding', code: '480' },
                        { id: 58, name: 'External Lock-Up & Eaves Materials', code: '490' },
                        { id: 59, name: 'Carpenter - External Lock-Up & Eaves', code: '495' },
                        { id: 60, name: 'Internal Doors & 2nd Fix Mouldings', code: '500' },
                        { id: 61, name: 'Fix Hardware', code: '510' },
                        { id: 62, name: 'Balcony Materials', code: '523' },
                        { id: 63, name: 'Balcony Labour', code: '524' },
                        { id: 64, name: 'Balustrades', code: '525' },
                        { id: 65, name: 'Carpenter - Fix Out', code: '530' },
                        { id: 66, name: 'Site Cleaner - 1st', code: '540' },
                        { id: 67, name: 'Waterproofing', code: '550' },
                        { id: 68, name: 'Cabinets', code: '560' },
                        // FINAL
                        { id: 69, name: 'Painter - Labour and Materials', code: '570' },
                        { id: 70, name: 'Painter - Quality Assurance Retention', code: '590' },
                        { id: 71, name: 'Ceramic Tiles - Supply', code: '600' },
                        { id: 72, name: 'Wall & Floor Tiles Labour', code: '610' },
                        { id: 73, name: 'Kitchen Sinks', code: '620' },
                        { id: 74, name: 'Robes, Shower Screens, Mirrors, Splashbacks', code: '630' },
                        { id: 75, name: 'Fit-Off Hardware & Door Furniture', code: '640' },
                        { id: 76, name: 'Carpenter - Fit-Off', code: '650' },
                        { id: 77, name: 'Garage Doors', code: '660' },
                        { id: 78, name: 'Gas Heating Systems', code: '670' },
                        { id: 79, name: 'Cooling Systems', code: '680' },
                        { id: 80, name: 'Toilet Suites, Troughs, Basins, Tapware', code: '690' },
                        { id: 81, name: 'Insulation to Ceilings', code: '700' },
                        { id: 82, name: 'Int. Cleaner (Pre-Clean Sweep)', code: '710' },
                        { id: 83, name: 'Joint Sealing and Caulking', code: '720' },
                        { id: 84, name: 'Retaining Walls – Landscaping', code: '730' },
                        { id: 85, name: 'Concrete Paving & Driveway', code: '740' },
                        { id: 86, name: 'Paving Accessories', code: '741' },
                        { id: 87, name: 'Termite Perimeter Treatment', code: '760' },
                        { id: 88, name: 'Window & Door Screens', code: '770' },
                        { id: 89, name: 'Clothes Line & Letterbox', code: '780' },
                        { id: 90, name: 'Window Coverings', code: '790' },
                        { id: 91, name: 'Timber Flooring', code: '805' },
                        { id: 92, name: 'Carpet & Floor Coverings', code: '810' },
                        { id: 93, name: 'Fencing', code: '820' },
                        { id: 94, name: 'Internal Cleaner', code: '830' },
                        { id: 95, name: 'Landscaping - Labour & Material', code: '840' },
                        { id: 96, name: 'Materials – Pergolas & Decks', code: '858' },
                        { id: 97, name: 'Carpenter – Pergolas & Decks', code: '860' },
                        { id: 98, name: 'Appliances - Electric and Gas', code: '870' },
                        { id: 99, name: 'HWS & Solar Collectors', code: '880' },
                        { id: 100, name: 'Rainwater Tanks', code: '890' },
                        { id: 101, name: 'Settlement Internal Re-Clean', code: '900' },
                        { id: 102, name: 'Appliance Internal Re-Clean', code: '901' },
                        { id: 103, name: 'Site Cleaner - Final', code: '910' },
                        { id: 104, name: 'Quality Assurance Touch Ups', code: '918' },
                        { id: 105, name: 'Quality Assurance Inspection', code: '920' }
                    ];

                    // Sample Contractors - now with tradeIds array
                    this.data.contractors = [
                        { id: 1, name: '1300 Temp Fence', email: 'hireteam@1300tempfence.com.au', phone: '', tradeIds: [5], trades: 'Silt Fence & Temporary Driveway' },
                        { id: 2, name: 'A & L Windows', email: '', phone: '', tradeIds: [88, 22], trades: 'Window & Door Screens, Windows & Entry Frames' },
                        { id: 3, name: 'AAA Rendering', email: 'aaarendering.services@yahoo.com.au', phone: '', tradeIds: [55], trades: 'Renderer & External Mouldings' },
                        { id: 4, name: 'ACS Water Blasting', email: 'rccallus@bigpond.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 5, name: 'Adam Safety Rail', email: 'admin@adamsafetyrail.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 6, name: 'Advanced Concrete Construction', email: 'adv.conc@bigpond.com', phone: '', tradeIds: [13, 14], trades: 'Piers & Screw Piles - Labour & Materials, Concrete Slabs & Footings' },
                        { id: 7, name: 'Advanced Living Solutions', email: 'sales@advancedlivingsolutions.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 8, name: 'All Green Nursery', email: 'orders@allgreen.com.au', phone: '', tradeIds: [38], trades: 'Brick Sand' },
                        { id: 9, name: 'ARV Plumbing', email: 'admin@arvplumbing.com; alex@arvplumbing.com', phone: '', tradeIds: [8, 9, 37], trades: 'Sewer & Water Supply Costs, Sewerage & Stormwater Drains, Plumber (Material & Labour)' },
                        { id: 10, name: 'Aspired Electrical', email: 'admin@aspiredelectrical.com', phone: '', tradeIds: [7, 45], trades: 'Electrical Mains, Electrical (Material & Labour)' },
                        { id: 11, name: 'ATOG', email: 'purchaseorders@atog.com.au', phone: '', tradeIds: [74], trades: 'Robes, Shower Screens, Mirrors, Splashbacks' },
                        { id: 12, name: 'Aus2 Services', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 13, name: 'Austral Bricks', email: 'majorscs.vic@australbricks.com.au', phone: '', tradeIds: [39], trades: 'Bricks' },
                        { id: 14, name: 'Bawi Bawi', email: 'bawibawirendering94@gmail.com', phone: '', tradeIds: [55], trades: 'Renderer & External Mouldings' },
                        { id: 15, name: 'Beaumont Tiles', email: 'vic.residential@tile.com.au', phone: '', tradeIds: [71], trades: 'Ceramic Tiles - Supply' },
                        { id: 16, name: 'Better Brick and Handover Cleaning', email: 'Steven@betterbrickcleaning.com.au', phone: '', tradeIds: [54], trades: 'Brick Cleaner' },
                        { id: 17, name: 'BJR - Cullen Roof Plumber', email: 'admin@cullenroofplumbing.com.au', phone: '', tradeIds: [30, 34, 43], trades: 'Metal Fascia & Gutters - Lab & Materials, Sheet Roofing (Material & Labour), Box Gutter, Cappings, Flashings' },
                        { id: 18, name: 'Blue Sovereign', email: 'chris.johnson@bigpond.com', phone: '', tradeIds: [93], trades: 'Fencing' },
                        { id: 19, name: 'BMH Roof Works', email: 'admin@bmhroof.com.au', phone: '', tradeIds: [30, 34, 43], trades: 'Metal Fascia & Gutters - Lab & Materials, Sheet Roofing (Material & Labour), Box Gutter, Cappings, Flashings' },
                        { id: 20, name: 'Bowens', email: '', phone: '', tradeIds: [47, 48, 50, 58, 60, 96], trades: 'Internal Lockup Materials, Lock Up Hardware, External Wall Cladding Materials, External Lock-Up & Eaves Materials, Internal Doors & 2nd Fix Mouldings, Materials – Pergolas & Decks' },
                        { id: 21, name: 'BPI', email: 'bookings@bpi360.com.au', phone: '', tradeIds: [105], trades: 'Quality Assurance Inspection' },
                        { id: 22, name: 'Brick to Brick', email: '', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 23, name: 'Building Waste Solutions', email: 'buildingwastesolutions@gmail.com', phone: '', tradeIds: [10, 18, 66, 31], trades: 'Spoil Removal – Drains, Site Grade Back - Post Slab, Site Cleaner - 1st, Site Cleaner - OH&S Clean' },
                        { id: 24, name: 'Bunnings', email: 'builderprojects@bunnings.com.au; pvine@bunnings.com.au', phone: '', tradeIds: [48, 73, 50, 58, 96, 80, 75, 97, 98, 47, 60], trades: 'Lock Up Hardware, Kitchen Sinks, External Wall Cladding Materials, External Lock-Up & Eaves Materials, Materials – Pergolas & Decks, Toilet Suites, Troughs, Basins, Tapware, Fit-Off Hardware & Door Furniture, Carpenter – Pergolas & Decks, Appliances - Electric and Gas, Internal Lockup Materials, Internal Doors & 2nd Fix Mouldings' },
                        { id: 25, name: 'Bunnings Frame & Truss Order', email: '', phone: '', tradeIds: [19, 24], trades: 'Pre-Fab Wall Frames & Roof Truss, Framing Materials and Hardware' },
                        { id: 26, name: 'Carpet Call', email: 'vic.builders3@carpetcall.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 27, name: 'Casabene Drain Cleaning', email: 'blockages@casabenegroup.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 28, name: 'Casabene Plumbing & Drainage', email: 'drains@casabenegroup.com.au', phone: '', tradeIds: [9, 11, 8], trades: 'Sewerage & Stormwater Drains, Rock Breakout and Removal, Sewer & Water Supply Costs' },
                        { id: 29, name: 'Checkpoint', email: 'inspectionbookings@check-point.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 30, name: 'Chromagen', email: 'vic_orders@chromagen.com.au', phone: '', tradeIds: [99], trades: 'HWS & Solar Collectors' },
                        { id: 31, name: 'City Side Glass', email: 'citysideglass@gmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 32, name: 'City West Water', email: 'technicalenquiries@citywestwater.com.au', phone: '', tradeIds: [8], trades: 'Sewer & Water Supply Costs' },
                        { id: 33, name: 'Cleaning Zone', email: 'cleaningzone@yahoo.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 34, name: 'CMB Brick', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 35, name: 'Complete Plumbing Services', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 36, name: 'Corinthian', email: 'orders-vic@cordoors.com', phone: '', tradeIds: [60], trades: 'Internal Doors & 2nd Fix Mouldings' },
                        { id: 37, name: 'Costas Plumbing', email: 'costasplumbing@bigpond.com', phone: '', tradeIds: [8, 37], trades: 'Sewer & Water Supply Costs, Plumber (Material & Labour)' },
                        { id: 38, name: 'Custom Concrete Solutions', email: 'cportill@bigpond.net.au', phone: '', tradeIds: [85], trades: 'Concrete Paving & Driveway' },
                        { id: 39, name: 'Dahlsens', email: '', phone: '', tradeIds: [19, 24], trades: 'Pre-Fab Wall Frames & Roof Truss, Framing Materials and Hardware' },
                        { id: 40, name: 'Dalkom Constructions', email: 'l_komadina@hotmail.com', phone: '', tradeIds: [6], trades: 'Set Out' },
                        { id: 41, name: 'Dean Rawle', email: 'ndrawle@yahoo.com', phone: '', tradeIds: [76], trades: 'Carpenter - Fit-Off' },
                        { id: 42, name: 'DFO Enterprises', email: 'dfobobcat@gmail.com', phone: '', tradeIds: [10, 18, 31, 66], trades: 'Spoil Removal – Drains, Site Grade Back - Post Slab, Site Cleaner - OH&S Clean, Site Cleaner - 1st' },
                        { id: 43, name: 'E & S Trading', email: 'jill.keays@eands.com.au', phone: '', tradeIds: [73, 80], trades: 'Kitchen Sinks, Toilet Suites, Troughs, Basins, Tapware' },
                        { id: 44, name: 'E & V Jukic', email: '', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 45, name: 'E&V Jukic AJ Bricklaying', email: '', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 46, name: 'Edge Screens', email: 'admin@edgescreens.com.au', phone: '', tradeIds: [74], trades: 'Robes, Shower Screens, Mirrors, Splashbacks' },
                        { id: 47, name: 'Eid Mohammad Tiling', email: 'eid.masterclasstiling@gmail.com', phone: '', tradeIds: [57, 72], trades: 'Feature Stone Cladding, Wall & Floor Tiles Labour' },
                        { id: 48, name: 'Emina Aliskovic', email: '', phone: '', tradeIds: [82, 94, 101], trades: 'Int. Cleaner (Pre-Clean Sweep), Internal Cleaner, Settlement Internal Re-Clean' },
                        { id: 49, name: 'Everlast Constructions', email: 'morebricksplease@hotmail.com', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 50, name: 'Express Gold', email: 'expressgold@bigpond.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 51, name: 'Fix n Chips', email: 'rachael@fixnchips.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 52, name: 'Fowles Auctions', email: 'John.Feehan@fowles.com.au', phone: '', tradeIds: [92], trades: 'Carpet & Floor Coverings' },
                        { id: 53, name: 'Geelong Spotless', email: '', phone: '', tradeIds: [82, 94, 101, 102], trades: 'Int. Cleaner (Pre-Clean Sweep), Internal Cleaner, Settlement Internal Re-Clean, Appliance Internal Re-Clean' },
                        { id: 54, name: 'Greater Western Water', email: '', phone: '', tradeIds: [8], trades: 'Sewer & Water Supply Costs' },
                        { id: 55, name: 'Guardrail 100', email: '', phone: '', tradeIds: [21, 27], trades: 'Perimeter Guardrail, Void Protection' },
                        { id: 56, name: 'Haider Bricklayer', email: 'haider.abbass1190@gmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 57, name: 'HAR Painters', email: 'info@harpainters.com.au', phone: '', tradeIds: [69, 70, 104], trades: 'Painter - Labour and Materials, Painter - Quality Assurance Retention, Quality Assurance Touch Ups' },
                        { id: 58, name: 'Hardings Hardware', email: 'call.ups@hth.com.au', phone: '', tradeIds: [73], trades: 'Kitchen Sinks' },
                        { id: 59, name: 'Harlzz Construction', email: 'Harlzzgoss@gmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 60, name: 'Hayden Browne Roof Plumbing', email: '', phone: '', tradeIds: [30, 34, 43], trades: 'Metal Fascia & Gutters - Lab & Materials, Sheet Roofing (Material & Labour), Box Gutter, Cappings, Flashings' },
                        { id: 61, name: 'Heaven Painting Services', email: '', phone: '', tradeIds: [69, 70, 104], trades: 'Painter - Labour and Materials, Painter - Quality Assurance Retention, Quality Assurance Touch Ups' },
                        { id: 62, name: 'High Flying Render', email: '', phone: '', tradeIds: [55], trades: 'Renderer & External Mouldings' },
                        { id: 63, name: 'Home + Industrial Soil', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 64, name: 'Htee Kleeh', email: 'hteekleeh9@outlook.com', phone: '', tradeIds: [49, 51, 65], trades: 'Carpenter - Internal Lock-Up, External Wall Cladding Labour, Carpenter - Fix Out' },
                        { id: 65, name: 'iHeat&Cool', email: 'kim@iheatandcool.com.au', phone: '', tradeIds: [78, 79], trades: 'Gas Heating Systems, Cooling Systems' },
                        { id: 66, name: 'Insulgreen Solutions', email: 'callup@insulgreensolutions.com.au', phone: '', tradeIds: [35, 81], trades: 'Foilwrap to External Walls, Insulation to Ceilings' },
                        { id: 67, name: 'Jack Hardy', email: 'jackandrewhardy98@gmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 68, name: 'James Ashcroft', email: '', phone: '', tradeIds: [25], trades: 'Carpenter - Wall Frame & Roof Trusses' },
                        { id: 69, name: 'Jason Tramsek', email: 'jasons.bricklaying@outlook.com', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 70, name: 'Jawad Jawad', email: 'waterproofingprotection@gmail.com', phone: '', tradeIds: [67], trades: 'Waterproofing' },
                        { id: 71, name: 'JDA Built', email: '', phone: '', tradeIds: [25], trades: 'Carpenter - Wall Frame & Roof Trusses' },
                        { id: 72, name: 'JDM Air', email: 'sales.jdmair@gmail.com', phone: '', tradeIds: [78, 79], trades: 'Gas Heating Systems, Cooling Systems' },
                        { id: 73, name: 'Josh - Bricklayer', email: 'josh_oconnor@bigpond.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 74, name: 'Jumbocorp', email: 'tradecustomers@jumbocorp.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 75, name: 'Just Residential Scaffold & Atf Services', email: 'info@jrscaff.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 76, name: 'Kalad Cleaning', email: 'bo_rawan_88@hotmail.com', phone: '', tradeIds: [82, 94, 101, 102], trades: 'Int. Cleaner (Pre-Clean Sweep), Internal Cleaner, Settlement Internal Re-Clean, Appliance Internal Re-Clean' },
                        { id: 77, name: 'Katam Drainage', email: 'Info@KatamDrainage.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 78, name: 'Kitchen Innovations', email: 'jackh@kitcheninnovations.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 79, name: 'Landscape 360', email: 'admin@landscape360group.com.au; nick@landscape360group.com.au', phone: '', tradeIds: [89, 95], trades: 'Clothes Line & Letterbox, Landscaping - Labour & Material' },
                        { id: 80, name: 'Leonard Cezmolli', email: 'Cezmolli_fixbuild@email.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 81, name: 'Lovelight', email: 'creationorders@lovelight.com.au', phone: '', tradeIds: [90], trades: 'Window Coverings' },
                        { id: 82, name: 'm2m Rendering', email: 'aida@m2mrendering.com.au', phone: '', tradeIds: [55], trades: 'Renderer & External Mouldings' },
                        { id: 83, name: 'MAW Carpentry', email: 'carpentry.maw@gmail.com', phone: '', tradeIds: [49, 51, 59, 65, 76], trades: 'Carpenter - Internal Lock-Up, External Wall Cladding Labour, Carpenter - External Lock-Up & Eaves, Carpenter - Fix Out, Carpenter - Fit-Off' },
                        { id: 84, name: 'Melbourne Civil Group', email: 'bookings@basecon.co', phone: '', tradeIds: [2], trades: 'Site Cut & Fill' },
                        { id: 85, name: 'Mende Najdov', email: 'najdov@yahoo.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 86, name: 'Meridian Pest Management', email: 'michelle.jordan@meridianpest.com.au', phone: '', tradeIds: [15, 44, 87], trades: 'Termite Proofing - Slab Penetrations, Physical Perimeter Termite Barrier, Termite Perimeter Treatment' },
                        { id: 87, name: 'Modern Options', email: 'ldp@modernoptions.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 88, name: 'Morr Plumbing', email: 'matthew@morrplumbing.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 89, name: 'Mouhammed Lababidi', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 90, name: 'Mtm Aluminium Wind.', email: 'androb@mtmaluminium.com.au', phone: '', tradeIds: [22, 88], trades: 'Windows & Entry Frames, Window & Door Screens' },
                        { id: 91, name: 'Name Of Imperium', email: '', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 92, name: 'Name Of Namdhari', email: 'mandeepmalhi2227@gmail.com', phone: '', tradeIds: [69, 70, 104], trades: 'Painter - Labour and Materials, Painter - Quality Assurance Retention, Quality Assurance Touch Ups' },
                        { id: 93, name: 'New Generation Painting', email: 'ahmadamilhem@icloud.com', phone: '', tradeIds: [69, 70, 104], trades: 'Painter - Labour and Materials, Painter - Quality Assurance Retention, Quality Assurance Touch Ups' },
                        { id: 94, name: 'Oldfields Advance Saffold', email: 'voids.knoxfield@oldfields.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 95, name: 'Powerwall Solutions', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 96, name: 'PTF Volume Builders', email: 'install@ptf.com.au', phone: '', tradeIds: [91], trades: 'Timber Flooring' },
                        { id: 97, name: 'Quake Earth Moviing', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 98, name: 'Quick Fit Glass', email: 'info@quickfitglass.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 99, name: 'R & R Cabinets', email: 'callups@rrcabinets.com.au', phone: '', tradeIds: [68], trades: 'Cabinets' },
                        { id: 100, name: 'Redback Bobcat & Tipper', email: '', phone: '', tradeIds: [31, 18, 66], trades: 'Site Cleaner - OH&S Clean, Site Grade Back - Post Slab, Site Cleaner - 1st' },
                        { id: 101, name: 'RPF Carpentry', email: 'rpfcarpentry@gmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 102, name: 'Ryker Carpentry', email: '', phone: '', tradeIds: [49, 51, 59, 65], trades: 'Carpenter - Internal Lock-Up, External Wall Cladding Labour, Carpenter - External Lock-Up & Eaves, Carpenter - Fix Out' },
                        { id: 103, name: 'S S Concreting', email: '', phone: '', tradeIds: [85], trades: 'Concrete Paving & Driveway' },
                        { id: 104, name: 'Shooter Construction', email: '', phone: '', tradeIds: [25], trades: 'Carpenter - Wall Frame & Roof Trusses' },
                        { id: 105, name: 'SM Crane Hire', email: 'asmcranehire@live.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 106, name: 'Smith Concreting Services', email: 'smithconservices@live.com.au', phone: '', tradeIds: [85], trades: 'Concrete Paving & Driveway' },
                        { id: 107, name: 'Snapshot Constructions', email: 'snapshotconstructions@gmail.com', phone: '', tradeIds: [25], trades: 'Carpenter - Wall Frame & Roof Trusses' },
                        { id: 108, name: 'Soe Soe', email: 'daysoe4588@gmail.com', phone: '', tradeIds: [76], trades: 'Carpenter - Fit-Off' },
                        { id: 109, name: 'Southern Star Windows', email: '', phone: '', tradeIds: [88, 22], trades: 'Window & Door Screens, Windows & Entry Frames' },
                        { id: 110, name: 'Speedy Bricklayers', email: 'Omarrali85@hotmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 111, name: 'Spiro Vladimiroski', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 112, name: 'SSC Building Group', email: '', phone: '', tradeIds: [25], trades: 'Carpenter - Wall Frame & Roof Trusses' },
                        { id: 113, name: 'SSH Tiling', email: 'hussains289@yahoo.com.au', phone: '', tradeIds: [57, 72], trades: 'Feature Stone Cladding, Wall & Floor Tiles Labour' },
                        { id: 114, name: 'Staight A Carpentry', email: 'alex@straightcarpentry.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 115, name: 'Stair Lock', email: '', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 116, name: 'Star Scaffolds', email: 'tullamarine@starscaffolds.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 117, name: 'Steel Line Garage Doors', email: 'installsvic@steel-line.com.au', phone: '', tradeIds: [77], trades: 'Garage Doors' },
                        { id: 118, name: 'Stela Group', email: 'callup@stelagroup.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 119, name: 'Stilcon', email: 'lintels@stilcon.com.au', phone: '', tradeIds: [42], trades: 'Brick Lintels' },
                        { id: 120, name: 'Stone Art', email: 'callups@stoneartaustralia.com.au', phone: '', tradeIds: [68], trades: 'Cabinets' },
                        { id: 121, name: 'SUPA Rendering Group', email: '', phone: '', tradeIds: [55], trades: 'Renderer & External Mouldings' },
                        { id: 122, name: 'Super Safe Hire', email: 'csr2@supersafehire.com.au', phone: '', tradeIds: [4, 5], trades: 'Site Facilities - Hire Equipment, Silt Fence & Temporary Driveway' },
                        { id: 123, name: 'Sure Seal Waterproofing', email: 'orders@suresealwaterproofing.com.au; michael@suresealwaterproofing.com.au', phone: '', tradeIds: [67], trades: 'Waterproofing' },
                        { id: 124, name: 'Taw', email: 'tawoo695@gmail.com', phone: '', tradeIds: [41], trades: 'Bricklayer Labour' },
                        { id: 125, name: 'Ted Guardrail', email: 'supervisor@tedguardrail.com.au', phone: '', tradeIds: [21, 27], trades: 'Perimeter Guardrail, Void Protection' },
                        { id: 126, name: 'Tiger Scaffold', email: 'info@tigerscaffold.com.au', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 127, name: 'Timi Caulking', email: 'timi@timis.com.au', phone: '', tradeIds: [83], trades: 'Joint Sealing and Caulking' },
                        { id: 128, name: 'Torpstar Carpentry', email: 'torpstar_constructions@hotmail.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 129, name: 'Vic Plaster', email: 'tyson.r@vicplaster.com.au; admin@vicplaster.com.au', phone: '', tradeIds: [53], trades: 'Plaster Linings (Materials & Labour)' },
                        { id: 130, name: 'Victoria Fencing', email: '', phone: '', tradeIds: [3, 84, 93], trades: 'Retaining Walls – Site Prep, Retaining Walls – Landscaping, Fencing' },
                        { id: 131, name: 'Volare Concepts', email: 'builders@volare.com.au', phone: '', tradeIds: [71], trades: 'Ceramic Tiles - Supply' },
                        { id: 132, name: 'VS Cleaning Services', email: 'vsaiyed86@gmail.com', phone: '', tradeIds: [54, 82, 94, 101, 102], trades: 'Brick Cleaner, Int. Cleaner (Pre-Clean Sweep), Internal Cleaner, Settlement Internal Re-Clean, Appliance Internal Re-Clean' },
                        { id: 133, name: 'Westside Group', email: 'westside.group.vicoffice@gmail.com', phone: '', tradeIds: [21, 27], trades: 'Perimeter Guardrail, Void Protection' },
                        { id: 134, name: 'Woddie (Jakrawan)', email: 'mista_wood@live.com', phone: '', tradeIds: [83], trades: 'Joint Sealing and Caulking' },
                        { id: 135, name: 'Woodys Timber', email: 'admin@woodystimber.com', phone: '', tradeIds: [], trades: 'No Trade Assigned' },
                        { id: 136, name: 'Yarra Valley Water', email: '', phone: '', tradeIds: [8], trades: 'Sewer & Water Supply Costs' },
                        { id: 137, name: 'Yousif TC', email: 'admin@bmhroof.com.au', phone: '', tradeIds: [83], trades: 'Joint Sealing and Caulking' },
                    ];

                    // Sample Addresses
                    this.data.addresses = [
                        { id: 1, street: '23 Shanti Cct', suburb: 'Werribee', propertyNumber: '3154' },
                        { id: 2, street: '26 Peterborough Rise', suburb: 'Werribee', propertyNumber: '7601' },
                        { id: 3, street: '56 Margie St', suburb: 'Wyndham Vale', propertyNumber: '130' },
                        { id: 4, street: '20 Fusion Drv', suburb: 'Wyndham Vale', propertyNumber: '5062' },
                        { id: 5, street: '29 Fritelli Cct', suburb: 'Wyndham Vale', propertyNumber: '5045' },
                        { id: 6, street: '12 Homecrest Cres', suburb: 'Wyndham Vale', propertyNumber: '4158' },
                        { id: 7, street: '12 Tuition Drv', suburb: 'Tarneit', propertyNumber: '1235' },
                        { id: 8, street: '21 Orientation Ave', suburb: 'Tarneit', propertyNumber: '1219' },
                        { id: 9, street: '79 Ornament Ave', suburb: 'Tarneit', propertyNumber: '1735' },
                        { id: 10, street: '9 Hickling Rd', suburb: 'Tarneit', propertyNumber: '1850' },
                        { id: 11, street: '37 Bronze St', suburb: 'Tarneit', propertyNumber: '303' },
                        { id: 12, street: '17 Lamonda St', suburb: 'Tarneit', propertyNumber: '1541' },
                        { id: 13, street: '37 Raindrop Cct', suburb: 'Fraser Rise', propertyNumber: '374' },
                        { id: 14, street: '37 Saric St', suburb: 'Fraser Rise', propertyNumber: '566' },
                        { id: 15, street: '11 Utopia Way', suburb: 'Weir Views', propertyNumber: '1711' },
                        { id: 16, street: '6 Rita Cres', suburb: 'Brookfield', propertyNumber: '38' },
                        { id: 17, street: '11 Neville St', suburb: 'Thornhill Park', propertyNumber: '3038' }
                    ];

                    // Sample Defects (empty - ready for your data)
                    this.data.defects = [];

                    this.save();
                }
            }

            // Address operations
            getAddresses() {
                return this.data.addresses.sort((a, b) => 
                    a.street.localeCompare(b.street)
                );
            }

            getAddress(id) {
                return this.data.addresses.find(a => a.id === id);
            }

            addAddress(address) {
                const id = Math.max(0, ...this.data.addresses.map(a => a.id)) + 1;
                const newAddress = { id, ...address };
                this.data.addresses.push(newAddress);
                this.save();
                return newAddress;
            }

            deleteAddress(id) {
                const defectCount = this.data.defects.filter(d => d.addressId === id && !d.completed).length;
                if (defectCount > 0) {
                    return { success: false, message: `Cannot delete. ${defectCount} active defects at this address.` };
                }
                this.data.addresses = this.data.addresses.filter(a => a.id !== id);
                this.save();
                return { success: true };
            }

            // Contractor operations
            getContractors() {
                return this.data.contractors.sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
            }

            getContractor(id) {
                return this.data.contractors.find(c => c.id === id);
            }

            addContractor(contractor) {
                const id = Math.max(0, ...this.data.contractors.map(c => c.id)) + 1;
                
                // Handle tradeIds as array
                const tradeIds = Array.isArray(contractor.tradeIds) ? contractor.tradeIds : 
                                contractor.tradeIds ? [contractor.tradeIds] : [];
                
                // Build trades string
                const trades = tradeIds.map(tid => {
                    const trade = this.data.trades.find(t => t.id === tid);
                    return trade ? trade.name : '';
                }).filter(Boolean).join(', ') || 'No Trade Assigned';
                
                const newContractor = { 
                    id, 
                    name: contractor.name, 
                    email: contractor.email || '',
                    phone: contractor.phone || '',
                    tradeIds, 
                    trades 
                };
                this.data.contractors.push(newContractor);
                this.save();
                return newContractor;
            }

            deleteContractor(id) {
                const defectCount = this.data.defects.filter(d => d.contractorId === id && !d.completed).length;
                if (defectCount > 0) {
                    return { success: false, message: `Cannot delete. ${defectCount} active defects for this contractor.` };
                }
                this.data.contractors = this.data.contractors.filter(c => c.id !== id);
                this.save();
                return { success: true };
            }

            // Trade operations
            getTrades() {
                return this.data.trades.sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
            }

            addTrade(trade) {
                const id = Math.max(0, ...this.data.trades.map(t => t.id)) + 1;
                const newTrade = { 
                    id, 
                    name: trade.name, 
                    code: trade.code || '',
                    hidden: trade.hidden || false 
                };
                this.data.trades.push(newTrade);
                this.save();
                return newTrade;
            }

            getTrades(includeHidden = true) {
                if (includeHidden) {
                    return this.data.trades;
                }
                return this.data.trades.filter(t => !t.hidden);
            }

            hideTradeById(id) {
                const trade = this.data.trades.find(t => t.id === id);
                if (trade) {
                    trade.hidden = true;
                    this.save();
                }
                return trade;
            }

            unhideTradeById(id) {
                const trade = this.data.trades.find(t => t.id === id);
                if (trade) {
                    trade.hidden = false;
                    this.save();
                }
                return trade;
            }

            deleteTrade(id) {
                const contractorCount = this.data.contractors.filter(c => c.tradeId === id).length;
                if (contractorCount > 0) {
                    return { success: false, message: `Cannot delete. ${contractorCount} contractors assigned to this trade.` };
                }
                this.data.trades = this.data.trades.filter(t => t.id !== id);
                this.save();
                return { success: true };
            }

            // Defect operations
            getDefects(filters = {}) {
                let defects = this.data.defects.filter(d => !d.completed);
                
                if (filters.addressId) {
                    defects = defects.filter(d => d.addressId === filters.addressId);
                }
                
                if (filters.contractorId) {
                    defects = defects.filter(d => d.contractorId === filters.contractorId);
                }
                
                if (filters.contractorIds && filters.contractorIds.length > 0) {
                    defects = defects.filter(d => filters.contractorIds.includes(d.contractorId));
                }

                // Enrich with address and contractor info
                return defects.map(d => ({
                    ...d,
                    address: this.getAddress(d.addressId),
                    contractor: this.getContractor(d.contractorId)
                }));
            }

            getDefectsByAddress(filters = {}) {
                const defects = this.getDefects(filters);
                const grouped = {};
                
                defects.forEach(defect => {
                    const addressKey = defect.addressId;
                    if (!grouped[addressKey]) {
                        grouped[addressKey] = {
                            address: defect.address,
                            defects: []
                        };
                    }
                    grouped[addressKey].defects.push(defect);
                });

                // Sort by street name
                return Object.values(grouped).sort((a, b) => 
                    a.address.street.localeCompare(b.address.street)
                );
            }

            addDefect(defect) {
                const id = Math.max(0, ...this.data.defects.map(d => d.id)) + 1;
                const newDefect = { id, ...defect, completed: false };
                this.data.defects.push(newDefect);
                this.save();
                return newDefect;
            }

            deleteDefect(id) {
                this.data.defects = this.data.defects.filter(d => d.id !== id);
                this.save();
            }

            markDefectComplete(id) {
                const defect = this.data.defects.find(d => d.id === id);
                if (defect) {
                    defect.completed = true;
                    this.save();
                }
            }

            // Export functions
            exportToText(defects) {
                let text = '';
                const grouped = this.getDefectsByAddress();
                
                grouped.forEach(group => {
                    text += `${group.address.street}\n`;
                    group.defects.forEach(defect => {
                        text += `  * ${defect.description}\n`;
                    });
                    text += '\n';
                });
                
                return text;
            }
        }

        // Initialize database
        const db = new DatabaseManager();

        // Application State
        const state = {
            currentView: 'home',
            filters: {},
            selectedContractors: [],
            selectedTrades: [],
            selectedTradeContractors: [],
            selectedTrade: null,
            selectedQuickAddress: null,
            selectedQuickContractor: null,
            selectedAddDefectsAddress: null,
            selectedAddDefectsContractor: null,
            selectedAddDefectsContractors: {}
        };

        // UI Helper Functions
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // View Components
        function renderHomeView() {
            return `
                <div class="app-header">
                    <div class="header-title">SMV Defect Manager Pro</div>
                </div>
                <div class="home-container">
                    <div class="section-title">View Defects</div>
                    
                    <div class="search-row">
                        <div class="search-label">Address</div>
                        <div class="search-input-wrapper autocomplete-container">
                            <input type="text" id="search-address" placeholder="Search" 
                                   oninput="handleAutocomplete(this, 'address')" 
                                   onfocus="handleAutocomplete(this, 'address')">
                            <div id="search-address-dropdown" class="autocomplete-dropdown"></div>
                            <button class="search-btn" onclick="searchByAddress()">🔍</button>
                        </div>
                    </div>

                    <div class="search-row">
                        <div class="search-label">Contractor</div>
                        <div class="search-input-wrapper autocomplete-container">
                            <input type="text" id="search-contractor" placeholder="Search" 
                                   oninput="handleAutocomplete(this, 'contractor')" 
                                   onfocus="handleAutocomplete(this, 'contractor')">
                            <div id="search-contractor-dropdown" class="autocomplete-dropdown"></div>
                            <button class="search-btn" onclick="searchByContractor()">🔍</button>
                        </div>
                    </div>

                    <div class="search-row">
                        <div class="search-label">Trade</div>
                        <div class="search-input-wrapper autocomplete-container">
                            <input type="text" id="search-trade" placeholder="Search" 
                                   oninput="handleAutocomplete(this, 'trade')" 
                                   onfocus="handleAutocomplete(this, 'trade')">
                            <div id="search-trade-dropdown" class="autocomplete-dropdown"></div>
                            <button class="search-btn" onclick="searchByTrade()">🔍</button>
                        </div>
                    </div>

                    <div class="section-title">Add Defects</div>
                    
                    <div class="search-row">
                        <div class="search-label">Address</div>
                        <div class="search-input-wrapper autocomplete-container">
                            <input type="text" id="add-address" placeholder="Search" 
                                   oninput="handleAutocomplete(this, 'address', 'add-address')" 
                                   onfocus="handleAutocomplete(this, 'address', 'add-address')">
                            <div id="add-address-dropdown" class="autocomplete-dropdown"></div>
                            <button class="search-btn" onclick="addDefectsByAddress()">🔍</button>
                        </div>
                    </div>

                    <div class="search-row">
                        <div class="search-label">Contractor</div>
                        <div class="search-input-wrapper autocomplete-container">
                            <input type="text" id="add-contractor" placeholder="Search" 
                                   oninput="handleAutocomplete(this, 'contractor', 'add-contractor')" 
                                   onfocus="handleAutocomplete(this, 'contractor', 'add-contractor')">
                            <div id="add-contractor-dropdown" class="autocomplete-dropdown"></div>
                            <button class="search-btn" onclick="addDefectsByContractor()">🔍</button>
                        </div>
                    </div>

                    <div class="section-title">Multiple Contractors</div>
                    <div class="multi-select-wrapper">
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-contractor-1" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'contractor', 'multi-contractor-1')" 
                                   onfocus="handleAutocomplete(this, 'contractor', 'multi-contractor-1')">
                            <div id="multi-contractor-1-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-contractor-2" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'contractor', 'multi-contractor-2')" 
                                   onfocus="handleAutocomplete(this, 'contractor', 'multi-contractor-2')">
                            <div id="multi-contractor-2-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-contractor-3" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'contractor', 'multi-contractor-3')" 
                                   onfocus="handleAutocomplete(this, 'contractor', 'multi-contractor-3')">
                            <div id="multi-contractor-3-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <button class="search-btn" onclick="searchMultipleContractors()">🔍</button>
                    </div>

                    <div class="section-title">Multiple Trades</div>
                    <div class="multi-select-wrapper">
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-trade-1" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'trade', 'multi-trade-1')" 
                                   onfocus="handleAutocomplete(this, 'trade', 'multi-trade-1')">
                            <div id="multi-trade-1-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-trade-2" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'trade', 'multi-trade-2')" 
                                   onfocus="handleAutocomplete(this, 'trade', 'multi-trade-2')">
                            <div id="multi-trade-2-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <div class="autocomplete-container" style="flex: 1;">
                            <input type="text" id="multi-trade-3" placeholder="Search"
                                   oninput="handleAutocomplete(this, 'trade', 'multi-trade-3')" 
                                   onfocus="handleAutocomplete(this, 'trade', 'multi-trade-3')">
                            <div id="multi-trade-3-dropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <button class="search-btn" onclick="searchMultipleTrades()">🔍</button>
                    </div>

                    <div class="manage-row">
                        <a href="#" class="manage-link" onclick="event.preventDefault(); showManageScreen()">
                            <span>⚙️</span>
                            <span>Manage</span>
                        </a>
                        <a href="#" class="view-all-link" onclick="event.preventDefault(); viewAllDefects()">View All Defects</a>
                    </div>
                </div>
            `;
        }

        function renderViewDefectsContractor(contractorId) {
            const contractor = db.getContractor(contractorId);
            const defectGroups = db.getDefectsByAddress({ contractorId });

            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">View Defects</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">${contractor.name}</div>
                        <div class="toolbar">
                            <button class="icon-btn" onclick="copyDefectsToClipboard()" title="Copy to Clipboard">📋</button>
                            <button class="icon-btn" onclick="emailDefectList()" title="Email Defect List">📧</button>
                            <button class="icon-btn" onclick="exportDefects()" title="Export">📄</button>
                            <button class="icon-btn" onclick="openAddDefectsForContractor(${contractorId})" title="Add">➕</button>
                            <button class="icon-btn" onclick="refreshDefects()" title="Refresh">🔄</button>
                        </div>
                    </div>

                    <!-- Contact Info Display with Edit -->
                    <div style="padding: 12px 20px; background: #f9f9f9; border-bottom: 1px solid var(--border-color); font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="margin-bottom: 5px;">
                                ${contractor.email ? 
                                    `📧 <a href="mailto:${contractor.email}" style="color: var(--blue); text-decoration: none;">${contractor.email}</a>` :
                                    `📧 <span style="color: #999;">No email</span>`
                                }
                            </div>
                            <div>
                                ${contractor.phone ? 
                                    `📞 <a href="tel:${contractor.phone}" style="color: var(--blue); text-decoration: none;">${contractor.phone}</a>` :
                                    `📞 <span style="color: #999;">No phone</span>`
                                }
                            </div>
                        </div>
                        <button class="icon-btn" onclick="openEditContactModal(${contractorId})" title="Edit Contact Info" style="font-size: 24px;">
                            ✏️
                        </button>
                    </div>

                    ${defectGroups.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No active defects for this contractor</p>
                        </div>
                    ` : defectGroups.map(group => `
                        <div class="contractor-section">
                            <div class="contractor-name">${group.address.street}</div>
                            ${group.defects.map(defect => `
                                <div class="defect-item">
                                    <span class="defect-text">${defect.description}</span>
                                    <input type="checkbox" class="defect-checkbox" 
                                           onchange="toggleDefectComplete(${defect.id})">
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderViewDefectsTrade(filters) {
            const { tradeName, contractorIds } = filters;
            const contractors = db.getContractors().filter(c => contractorIds.includes(c.id));
            const defects = db.getDefects().filter(d => contractorIds.includes(d.contractorId));
            
            // Group by contractor, then by address
            const byContractor = {};
            defects.forEach(d => {
                if (!byContractor[d.contractorId]) {
                    byContractor[d.contractorId] = {
                        contractor: db.getContractor(d.contractorId),
                        addresses: {}
                    };
                }
                if (!byContractor[d.contractorId].addresses[d.addressId]) {
                    byContractor[d.contractorId].addresses[d.addressId] = {
                        address: db.getAddress(d.addressId),
                        defects: []
                    };
                }
                byContractor[d.contractorId].addresses[d.addressId].defects.push(d);
            });

            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">View Defects</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">${tradeName}</div>
                        <div class="toolbar">
                            <button class="icon-btn" onclick="copyDefectsToClipboard()" title="Copy to Clipboard">📋</button>
                            <button class="icon-btn" onclick="emailDefectList()" title="Email List">📧</button>
                            <button class="icon-btn" onclick="exportDefects()" title="Export">📄</button>
                            <button class="icon-btn" onclick="refreshDefects()" title="Refresh">🔄</button>
                        </div>
                    </div>

                    ${Object.keys(byContractor).length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No active defects for this trade</p>
                        </div>
                    ` : Object.values(byContractor).map(contractorGroup => `
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 17px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; padding: 12px 20px; background: #f9f9f9; border-bottom: 1px solid var(--border-color);">
                                ${contractorGroup.contractor.name}
                            </div>
                            ${Object.values(contractorGroup.addresses).map(addressGroup => `
                                <div class="contractor-section">
                                    <div class="contractor-name">${addressGroup.address.street}, ${addressGroup.address.suburb}</div>
                                    ${addressGroup.defects.map(defect => `
                                        <div class="defect-item">
                                            <span class="defect-text">${defect.description}</span>
                                            <input type="checkbox" class="defect-checkbox" 
                                                   onchange="toggleDefectComplete(${defect.id})">
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderViewDefectsAddress(addressId) {
            const address = db.getAddress(addressId);
            const defects = db.getDefects({ addressId });
            
            // Group by contractor
            const byContractor = {};
            defects.forEach(d => {
                if (!byContractor[d.contractorId]) {
                    byContractor[d.contractorId] = {
                        contractor: d.contractor,
                        defects: []
                    };
                }
                byContractor[d.contractorId].defects.push(d);
            });

            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">View Defects</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">Lot ${address.propertyNumber} [${address.street.split(' ')[0]}] ${address.street}, ${address.suburb}</div>
                        <div class="toolbar">
                            <button class="icon-btn" onclick="copyDefectsToClipboard()" title="Copy to Clipboard">📋</button>
                            <button class="icon-btn" onclick="emailDefectList()" title="Email List">📧</button>
                            <button class="icon-btn" onclick="exportDefects()" title="Export">📄</button>
                            <button class="icon-btn" onclick="openModal('add-address-options-modal')" title="Add Addresses">➕</button>
                            <button class="icon-btn" onclick="refreshDefects()" title="Refresh">🔄</button>
                        </div>
                    </div>

                    ${Object.keys(byContractor).length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No active defects at this address</p>
                        </div>
                    ` : Object.values(byContractor).map(group => `
                        <div class="contractor-section">
                            <div class="contractor-name">${group.contractor.name}</div>
                            ${group.defects.map(defect => `
                                <div class="defect-item">
                                    <span class="defect-text">${defect.description}</span>
                                    <input type="checkbox" class="defect-checkbox" 
                                           onchange="toggleDefectComplete(${defect.id})">
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAddDefectsAddress(addressId) {
            const address = db.getAddress(addressId);
            
            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">Add Defects</div>
                        <button class="icon-btn" onclick="saveAddDefectsAddress()" title="Save Defects">💾</button>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">Lot ${address.propertyNumber} [${address.street.split(' ')[0]}] ${address.street}, ${address.suburb}</div>
                    </div>

                    <div style="padding: 20px;">
                        <!-- Contractor 1 -->
                        <div style="margin-bottom: 25px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color);">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Contractor 1:</label>
                            <div class="autocomplete-container" style="position: relative; margin-bottom: 15px;">
                                <input type="text" 
                                       id="add-contractor-1-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleAddDefectsContractorAutocomplete(this, 1)"
                                       onfocus="handleAddDefectsContractorAutocomplete(this, 1)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-contractor-1-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-1" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-1" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-1" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                        </div>

                        <!-- Contractor 2 -->
                        <div style="margin-bottom: 25px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color);">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Contractor 2:</label>
                            <div class="autocomplete-container" style="position: relative; margin-bottom: 15px;">
                                <input type="text" 
                                       id="add-contractor-2-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleAddDefectsContractorAutocomplete(this, 2)"
                                       onfocus="handleAddDefectsContractorAutocomplete(this, 2)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-contractor-2-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-2" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-2" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-2" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                        </div>

                        <!-- Contractor 3 -->
                        <div style="margin-bottom: 25px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color);">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Contractor 3:</label>
                            <div class="autocomplete-container" style="position: relative; margin-bottom: 15px;">
                                <input type="text" 
                                       id="add-contractor-3-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleAddDefectsContractorAutocomplete(this, 3)"
                                       onfocus="handleAddDefectsContractorAutocomplete(this, 3)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-contractor-3-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-3" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-3" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-3" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                        </div>

                        <!-- Contractor 4 -->
                        <div style="margin-bottom: 25px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color);">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Contractor 4:</label>
                            <div class="autocomplete-container" style="position: relative; margin-bottom: 15px;">
                                <input type="text" 
                                       id="add-contractor-4-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleAddDefectsContractorAutocomplete(this, 4)"
                                       onfocus="handleAddDefectsContractorAutocomplete(this, 4)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-contractor-4-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-4" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-4" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-4" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                        </div>

                        <!-- Contractor 5 -->
                        <div style="margin-bottom: 25px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color);">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Contractor 5:</label>
                            <div class="autocomplete-container" style="position: relative; margin-bottom: 15px;">
                                <input type="text" 
                                       id="add-contractor-5-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleAddDefectsContractorAutocomplete(this, 5)"
                                       onfocus="handleAddDefectsContractorAutocomplete(this, 5)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-contractor-5-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-5" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-5" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                            <div class="defect-input-row"><span>•</span><input type="text" class="add-defect-5" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAddDefectsContractor(contractorId) {
            const contractor = db.getContractor(contractorId);
            
            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">Add Defects</div>
                        <button class="icon-btn" onclick="saveAddDefectsContractor()" title="Save Defects">💾</button>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">${contractor.name}</div>
                    </div>

                    <div style="padding: 20px;">
                        <!-- Address Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Select Address:</label>
                            <div class="autocomplete-container" style="position: relative;">
                                <input type="text" 
                                       id="add-defects-address-input" 
                                       placeholder="Start typing address..." 
                                       oninput="handleAddDefectsAddressAutocomplete(this)"
                                       onfocus="handleAddDefectsAddressAutocomplete(this)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="add-defects-address-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </div>

                        <!-- Defects -->
                        <div>
                            <label style="display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px;">Defects:</label>
                            <div id="add-defects-contractor-container">
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="add-defect-contractor-input" placeholder="Enter defect" style="flex: 1; padding: 10px; border: 1px solid #c6c6c8; border-radius: 8px; font-size: 16px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMultipleContractorsView(contractorIds) {
            const contractors = contractorIds.map(id => db.getContractor(id));
            const contractorNames = contractors.map(c => c.name).join(', ');
            const defectGroups = db.getDefectsByAddress({ contractorIds });

            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">View Defects</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">Search Multiple Contractors:<br><span style="font-size: 14px; font-weight: 400; color: #666;">${contractorNames}</span></div>
                        <div class="toolbar">
                            <button class="icon-btn" onclick="copyDefectsToClipboard()" title="Copy to Clipboard">📋</button>
                            <button class="icon-btn" onclick="emailDefectList()" title="Email List">📧</button>
                            <button class="icon-btn" onclick="exportDefects()" title="Export">📄</button>
                            <button class="icon-btn" onclick="refreshDefects()" title="Refresh">🔄</button>
                        </div>
                    </div>

                    ${defectGroups.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No active defects for selected contractors</p>
                        </div>
                    ` : defectGroups.map(group => `
                        <div class="contractor-section">
                            <div class="contractor-name">${group.address.street}</div>
                            ${group.defects.map(defect => `
                                <div class="defect-item">
                                    <span class="defect-text">${defect.description} <span style="color: #8e8e93; font-size: 13px;">[${defect.contractor.name}]</span></span>
                                    <input type="checkbox" class="defect-checkbox" 
                                           onchange="toggleDefectComplete(${defect.id})">
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAllDefectsView() {
            // Get all defects grouped by address
            const allDefects = db.data.defects.filter(d => !d.completed);
            
            // Group by address, then by trade
            const groupedByAddress = {};
            allDefects.forEach(defect => {
                const address = db.getAddress(defect.addressId);
                const contractor = db.getContractor(defect.contractorId);
                
                if (!address || !contractor) return;
                
                const addressKey = `${address.street}, ${address.suburb}`;
                if (!groupedByAddress[addressKey]) {
                    groupedByAddress[addressKey] = {
                        address: address,
                        trades: {}
                    };
                }
                
                // Group by trade within address
                const tradeName = contractor.trades || 'No Trade Assigned';
                if (!groupedByAddress[addressKey].trades[tradeName]) {
                    groupedByAddress[addressKey].trades[tradeName] = [];
                }
                
                groupedByAddress[addressKey].trades[tradeName].push({
                    ...defect,
                    contractor: contractor
                });
            });

            // Convert to sorted array
            const addressGroups = Object.keys(groupedByAddress)
                .sort()
                .map(key => ({
                    addressKey: key,
                    address: groupedByAddress[key].address,
                    trades: groupedByAddress[key].trades
                }));

            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">All Defects</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="defects-header">
                        <div class="lot-title">All Defects by Address</div>
                        <div class="toolbar">
                            <button class="icon-btn" onclick="copyDefectsToClipboard()" title="Copy to Clipboard">📋</button>
                            <button class="icon-btn" onclick="emailDefectList()" title="Email List">📧</button>
                            <button class="icon-btn" onclick="exportDefects()" title="Export">📄</button>
                            <button class="icon-btn" onclick="refreshDefects()" title="Refresh">🔄</button>
                        </div>
                    </div>

                    ${addressGroups.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <p>No active defects</p>
                        </div>
                    ` : addressGroups.map(addressGroup => `
                        <div class="contractor-section">
                            <div class="contractor-name" style="background: #f9f9f9; padding: 12px 15px; margin: -20px -20px 15px -20px; border-radius: 0; font-size: 18px; color: #000;">
                                📍 ${addressGroup.addressKey}
                            </div>
                            ${Object.keys(addressGroup.trades).sort().map(tradeName => `
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 15px; font-weight: 600; color: #666; margin-bottom: 10px; padding-left: 10px; border-left: 3px solid #007AFF;">
                                        ${tradeName}
                                    </div>
                                    ${addressGroup.trades[tradeName].map(defect => `
                                        <div class="defect-item">
                                            <span class="defect-text">
                                                ${defect.description}
                                                <span style="color: #8e8e93; font-size: 13px;"> — ${defect.contractor.name}</span>
                                            </span>
                                            <input type="checkbox" class="defect-checkbox" 
                                                   ${defect.completed ? 'checked' : ''}
                                                   onchange="toggleDefectComplete(${defect.id})">
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderManageScreen() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            return `
                <div class="defects-container">
                    <div class="app-header">
                        <a href="#" class="back-link" onclick="event.preventDefault(); showHomeView()">Back</a>
                        <div class="header-title">Manage</div>
                        <div style="width: 60px;"></div>
                    </div>
                    
                    <div class="manage-container">
                        <!-- Dark Mode Toggle -->
                        <div style="margin-bottom: 20px; padding: 20px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 17px; font-weight: 600; margin-bottom: 5px; color: var(--text-primary);">
                                        ${isDarkMode ? '🌙' : '☀️'} ${isDarkMode ? 'Dark' : 'Light'} Mode
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">
                                        Switch between light and dark themes
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn ${!isDarkMode ? 'btn-primary' : 'btn-secondary'}" 
                                            style="padding: 10px 20px; font-size: 14px;" 
                                            onclick="setTheme('light')">
                                        ☀️ Light
                                    </button>
                                    <button class="btn ${isDarkMode ? 'btn-primary' : 'btn-secondary'}" 
                                            style="padding: 10px 20px; font-size: 14px;" 
                                            onclick="setTheme('dark')">
                                        🌙 Dark
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="import-section" onclick="document.getElementById('excel-import').click()">
                            <div style="font-size: 48px; margin-bottom: 15px;">📁</div>
                            <div style="font-size: 17px; font-weight: 600; color: var(--blue);">Import Excel File</div>
                            <div style="color: #8e8e93; margin-top: 10px; font-size: 15px;">Tap to upload addresses, contractors, and trades</div>
                            <input type="file" id="excel-import" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
                        </div>

                        <div style="margin-bottom: 20px; padding: 20px; background: #F5F5F5; border: 1px solid #E0E0E0; border-radius: 10px;">
                            <div style="font-size: 17px; font-weight: 600; margin-bottom: 10px;">📊 Database Status</div>
                            <div style="font-size: 14px; color: #555; line-height: 1.8;">
                                Addresses: <strong>${db.getAddresses().length}</strong><br>
                                Contractors: <strong>${db.getContractors().length}</strong><br>
                                Trades: <strong>${db.getTrades().length}</strong><br>
                                Defects: <strong>${db.data.defects.length}</strong>
                            </div>
                            ${(db.getAddresses().length === 0 && db.getContractors().length === 0) ? `
                                <div style="margin-top: 15px; padding: 10px; background: #FFF3CD; border-radius: 6px; font-size: 13px; color: #856404;">
                                    ⚠️ No data found! Use "Reset Database" below to load sample data, or "Import Backup" to restore from file.
                                </div>
                            ` : ''}
                        </div>

                        <div style="margin-bottom: 20px; padding: 20px; background: #E3F2FD; border: 2px solid #2196F3; border-radius: 10px; text-align: center;">
                            <div style="font-size: 17px; font-weight: 600; margin-bottom: 10px; color: #1976D2;">💾 Backup & Restore</div>
                            <div style="font-size: 14px; color: #8e8e93; margin-bottom: 15px;">
                                Export all data to JSON file or import from a backup file
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="exportAllData()">
                                    Export Backup
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('import-backup-file').click()">
                                    Import Backup
                                </button>
                            </div>
                            <input type="file" id="import-backup-file" accept=".json" style="display: none;" onchange="handleBackupImport(event)">
                        </div>

                        <div style="margin-bottom: 30px; padding: 20px; background: #FFF3CD; border: 2px solid #FF9800; border-radius: 10px; text-align: center;">
                            <div style="font-size: 17px; font-weight: 600; margin-bottom: 10px; color: #FF6B00;">🔄 Update Contractor Trades</div>
                            <div style="font-size: 14px; color: #8e8e93; margin-bottom: 15px;">
                                Update all contractors with their assigned trades from the template.<br>
                                ✅ Keeps all addresses, defects, and data<br>
                                ✅ Only updates trade assignments for contractors
                            </div>
                            <button class="btn btn-primary" style="width: 100%; background: #FF9800; border-color: #FF9800;" onclick="reloadContractorTrades()">
                                Update Contractor Trades
                            </button>
                        </div>

                        <div style="margin-bottom: 30px; padding: 20px; background: #FFE5E5; border: 2px solid #FF3B30; border-radius: 10px; text-align: center;">
                            <div style="font-size: 17px; font-weight: 600; margin-bottom: 10px; color: #FF3B30;">⚠️ Advanced: Reset Database</div>
                            <div style="font-size: 14px; color: #8e8e93; margin-bottom: 15px;">
                                ⚠️ <strong>DANGER:</strong> This will delete ALL data (addresses, contractors, defects, trades)<br>
                                Only use this if you need to start completely fresh.<br>
                                💡 Tip: Export your data first using the button above!
                            </div>
                            <button class="btn btn-danger" style="width: 100%;" onclick="resetDatabase()">
                                ⚠️ Reset Database & Reload Trades
                            </button>
                        </div>

                        <div class="crud-list">
                            <div class="crud-item">
                                <span class="crud-item-label">Job Address</span>
                                <div class="crud-actions">
                                    <button class="btn btn-primary" onclick="openModal('add-address-options-modal')">Add</button>
                                    <button class="btn btn-danger" onclick="openModal('delete-address-modal')">Delete</button>
                                </div>
                            </div>

                            <div class="crud-item">
                                <span class="crud-item-label">Trade Type</span>
                                <div class="crud-actions">
                                    <button class="btn btn-primary" onclick="openModal('add-trade-options-modal')">Add</button>
                                    <button class="btn btn-secondary" onclick="openModal('hide-trade-modal')">Hide</button>
                                    <button class="btn btn-secondary" onclick="openModal('unhide-trade-modal')">Unhide</button>
                                    <button class="btn btn-danger" onclick="openModal('delete-trade-modal')">Delete</button>
                                </div>
                            </div>

                            <div class="crud-item">
                                <span class="crud-item-label">Contractor</span>
                                <div class="crud-actions">
                                    <button class="btn btn-primary" onclick="openModal('add-contractor-options-modal')">Add</button>
                                    <button class="btn btn-secondary" onclick="openBulkAssignTrades()">Bulk Assign Trades</button>
                                    <button class="btn btn-danger" onclick="openModal('delete-contractor-modal')">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Action Functions
        function searchByAddress() {
            const input = document.getElementById('search-address').value.trim();
            
            // If empty, show all addresses list
            if (!input) {
                showAllAddressesList();
                return;
            }
            
            const address = db.getAddresses().find(a => 
                a.street.toLowerCase().includes(input.toLowerCase())
            );
            if (address) {
                state.currentView = 'view-defects-address';
                state.filters = { addressId: address.id };
                render();
            } else {
                showToast('Address not found', true);
            }
        }

        function searchByContractor() {
            const input = document.getElementById('search-contractor').value.trim();
            
            // If empty, show all contractors list
            if (!input) {
                showAllContractorsList();
                return;
            }
            
            const contractor = db.getContractors().find(c => 
                c.name.toLowerCase().includes(input.toLowerCase())
            );
            if (contractor) {
                state.currentView = 'view-defects-contractor';
                state.filters = { contractorId: contractor.id };
                render();
            } else {
                showToast('Contractor not found', true);
            }
        }

        function searchByTrade() {
            const input = document.getElementById('search-trade').value.trim();
            
            // If empty, show all trades list
            if (!input) {
                showAllTradesList();
                return;
            }
            
            const trade = db.getTrades().find(t => 
                t.name.toLowerCase().includes(input.toLowerCase())
            );
            if (trade) {
                showDefectsForTrade(trade.id);
            } else {
                showToast('Trade not found', true);
            }
        }

        function showDefectsForTrade(tradeId) {
            const trade = db.getTrades().find(t => t.id === tradeId);
            const contractors = db.getContractors().filter(c => 
                c.tradeIds && c.tradeIds.includes(tradeId)
            );
            
            if (contractors.length === 0) {
                showToast('No contractors found for this trade', true);
                return;
            }
            
            // Get all defects from contractors with this trade
            const contractorIds = contractors.map(c => c.id);
            const defects = db.getDefects().filter(d => 
                contractorIds.includes(d.contractorId)
            );
            
            // Update view state
            state.currentView = 'view-defects-trade';
            state.filters = { 
                tradeId: tradeId,
                tradeName: trade.name,
                contractorIds: contractorIds
            };
            
            render();
        }

        function showAllAddressesList() {
            openModal('all-addresses-list-modal');
        }

        function showAllContractorsList() {
            openModal('all-contractors-list-modal');
        }

        function showAllTradesList() {
            openModal('all-trades-list-modal');
        }

        function selectAddressFromList(addressId) {
            state.currentView = 'view-defects-address';
            state.filters = { addressId: parseInt(addressId) };
            closeModal('all-addresses-list-modal');
            render();
        }

        function selectContractorFromList(contractorId) {
            state.currentView = 'view-defects-contractor';
            state.filters = { contractorId: parseInt(contractorId) };
            closeModal('all-contractors-list-modal');
            render();
        }

        function showContractorsForTrade(tradeId) {
            const trade = db.getTrades().find(t => t.id === tradeId);
            const contractors = db.getContractors().filter(c => 
                c.tradeIds && c.tradeIds.includes(tradeId)
            );
            
            // Update modal header
            document.getElementById('trade-modal-header').textContent = `${trade.name}s`;
            
            // Populate contractors list
            const listContainer = document.getElementById('contractors-by-trade-list');
            
            if (contractors.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8e8e93;">
                        No contractors found for this trade
                    </div>
                `;
            } else {
                listContainer.innerHTML = contractors.map(c => `
                    <div class="defect-item" style="cursor: pointer; background: var(--bg-primary); margin-bottom: 5px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;" 
                         onclick="selectContractorFromTrade(${c.id})">
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 14px; color: #8e8e93;">${c.trades || 'No Trade Assigned'}</div>
                    </div>
                `).join('');
            }
            
            // Close trades modal and open contractors modal
            closeModal('all-trades-list-modal');
            openModal('contractors-by-trade-modal');
        }

        function showUnassignedContractors() {
            const contractors = db.getContractors().filter(c => 
                !c.tradeIds || c.tradeIds.length === 0
            );
            
            // Update modal header
            document.getElementById('trade-modal-header').textContent = 'Unassigned Contractors';
            
            // Populate contractors list
            const listContainer = document.getElementById('contractors-by-trade-list');
            
            if (contractors.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8e8e93;">
                        All contractors have been assigned to trades
                    </div>
                `;
            } else {
                listContainer.innerHTML = contractors.map(c => `
                    <div class="defect-item" style="cursor: pointer; background: var(--bg-primary); margin-bottom: 5px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;" 
                         onclick="selectContractorFromTrade(${c.id})">
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 14px; color: #FF3B30;">⚠️ No Trade Assigned</div>
                    </div>
                `).join('');
            }
            
            // Close trades modal and open contractors modal
            closeModal('all-trades-list-modal');
            openModal('contractors-by-trade-modal');
        }

        function selectContractorFromTrade(contractorId) {
            state.currentView = 'view-defects-contractor';
            state.filters = { contractorId: parseInt(contractorId) };
            closeModal('contractors-by-trade-modal');
            render();
        }

        function viewAllDefects() {
            const allDefects = db.getDefectsByAddress();
            state.currentView = 'view-all-defects';
            render();
        }

        // Autocomplete functionality
        function handleAutocomplete(input, type, inputId) {
            const value = input.value.toLowerCase();
            const dropdownId = (inputId || input.id) + '-dropdown';
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) return;
            
            // Determine if this is a "view" field or "add" field
            const isViewField = input.id.startsWith('search-');
            
            let items = [];
            
            if (type === 'address') {
                const isNumeric = /^\d/.test(value); // Check if searching for a number
                
                items = db.getAddresses().filter(a => {
                    const lowerValue = value;
                    const streetWords = a.street.toLowerCase().split(' ');
                    const suburbWords = a.suburb.toLowerCase().split(' ');
                    const lotNumber = a.propertyNumber ? a.propertyNumber.toLowerCase() : '';
                    
                    // If searching for a number, match lot numbers and street numbers
                    if (isNumeric) {
                        return lotNumber.startsWith(lowerValue) ||
                               streetWords.some(word => word.startsWith(lowerValue));
                    }
                    
                    // Otherwise, match street/suburb words
                    return streetWords.some(word => word.startsWith(lowerValue)) || 
                           suburbWords.some(word => word.startsWith(lowerValue));
                })
                .sort((a, b) => {
                    if (isNumeric) {
                        // When searching numbers, prioritize lot number matches
                        const aLotMatch = a.propertyNumber && a.propertyNumber.toLowerCase().startsWith(value);
                        const bLotMatch = b.propertyNumber && b.propertyNumber.toLowerCase().startsWith(value);
                        
                        if (aLotMatch && !bLotMatch) return -1;
                        if (!aLotMatch && bLotMatch) return 1;
                        
                        // Then street number matches
                        const aStreetFirst = a.street.toLowerCase().split(' ')[0];
                        const bStreetFirst = b.street.toLowerCase().split(' ')[0];
                        const aStreetMatch = aStreetFirst.startsWith(value);
                        const bStreetMatch = bStreetFirst.startsWith(value);
                        
                        if (aStreetMatch && !bStreetMatch) return -1;
                        if (!aStreetMatch && bStreetMatch) return 1;
                    } else {
                        // When searching letters, check if match is in street vs suburb
                        const aStreetWords = a.street.toLowerCase().split(' ');
                        const bStreetWords = b.street.toLowerCase().split(' ');
                        const aSuburbWords = a.suburb.toLowerCase().split(' ');
                        const bSuburbWords = b.suburb.toLowerCase().split(' ');
                        
                        const aStreetMatch = aStreetWords.some(word => word.startsWith(value));
                        const bStreetMatch = bStreetWords.some(word => word.startsWith(value));
                        const aSuburbMatch = aSuburbWords.some(word => word.startsWith(value));
                        const bSuburbMatch = bSuburbWords.some(word => word.startsWith(value));
                        
                        // Prioritize street matches over suburb matches
                        if (aStreetMatch && !bStreetMatch) return -1;
                        if (!aStreetMatch && bStreetMatch) return 1;
                        
                        // Both are street matches - check if first word matches
                        if (aStreetMatch && bStreetMatch) {
                            const aFirstWord = aStreetWords[0].startsWith(value);
                            const bFirstWord = bStreetWords[0].startsWith(value);
                            
                            if (aFirstWord && !bFirstWord) return -1;
                            if (!aFirstWord && bFirstWord) return 1;
                        }
                        
                        // Both are suburb matches - no special priority
                    }
                    
                    // If both equal priority, sort alphabetically
                    return a.street.localeCompare(b.street);
                })
                .map(a => ({
                    label: `${a.street}, ${a.suburb}`,
                    value: a.street,
                    id: a.id,
                    type: 'address'
                }));
            } else if (type === 'contractor') {
                items = db.getContractors().filter(c => {
                    const nameWords = c.name.toLowerCase().split(' ');
                    const tradesWords = c.trades ? c.trades.toLowerCase().split(' ') : [];
                    return nameWords.some(word => word.startsWith(value)) ||
                           tradesWords.some(word => word.startsWith(value));
                })
                .sort((a, b) => {
                    const aFirstWord = a.name.toLowerCase().split(' ')[0];
                    const bFirstWord = b.name.toLowerCase().split(' ')[0];
                    const aStartsWithValue = aFirstWord.startsWith(value);
                    const bStartsWithValue = bFirstWord.startsWith(value);
                    
                    // Prioritize contractors whose first word starts with the value
                    if (aStartsWithValue && !bStartsWithValue) return -1;
                    if (!aStartsWithValue && bStartsWithValue) return 1;
                    
                    // If both start with value (or both don't), sort alphabetically
                    return a.name.localeCompare(b.name);
                })
                .map(c => ({
                    label: `${c.name} - ${c.trades || 'No Trade'}`,
                    value: c.name,
                    id: c.id,
                    type: 'contractor'
                }));
            } else if (type === 'trade') {
                items = db.getTrades().filter(t => {
                    const tradeWords = t.name.toLowerCase().split(' ');
                    return tradeWords.some(word => word.startsWith(value));
                })
                .sort((a, b) => {
                    const aFirstWord = a.name.toLowerCase().split(' ')[0];
                    const bFirstWord = b.name.toLowerCase().split(' ')[0];
                    const aStartsWithValue = aFirstWord.startsWith(value);
                    const bStartsWithValue = bFirstWord.startsWith(value);
                    
                    // Prioritize trades whose first word starts with the value
                    if (aStartsWithValue && !bStartsWithValue) return -1;
                    if (!aStartsWithValue && bStartsWithValue) return 1;
                    
                    // If both start with value (or both don't), sort alphabetically
                    return a.name.localeCompare(b.name);
                })
                .map(t => ({
                    label: t.name,
                    value: t.name,
                    id: t.id,
                    type: 'trade'
                }));
            }
            
            if (items.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = items.slice(0, 5).map(item => `
                <div class="autocomplete-item" onclick="selectAutocomplete('${input.id}', '${item.value.replace(/'/g, "\\'")}', '${dropdownId}', ${item.id}, '${item.type}', ${isViewField})">
                    ${item.label}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectAutocomplete(inputId, value, dropdownId, itemId, itemType, isViewField) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (dropdown) dropdown.classList.remove('active');
            
            // If this is a "view" field (search-address, search-contractor, search-trade), navigate to view page
            if (isViewField) {
                if (itemType === 'address') {
                    state.currentView = 'view-defects-address';
                    state.filters = { addressId: itemId };
                    render();
                } else if (itemType === 'contractor') {
                    state.currentView = 'view-defects-contractor';
                    state.filters = { contractorId: itemId };
                    render();
                } else if (itemType === 'trade') {
                    // For trade, show defects from contractors with that trade
                    showDefectsForTrade(itemId);
                }
            } else {
                // For "add" fields, navigate to add-defects page
                if (inputId === 'add-address') {
                    state.currentView = 'add-defects-address';
                    state.filters = { addressId: itemId };
                    render();
                } else if (inputId === 'add-contractor') {
                    state.currentView = 'add-defects-contractor';
                    state.filters = { contractorId: itemId };
                    render();
                } else {
                    // For other fields (like in modals), just fill in the value
                    if (input) input.value = value;
                }
            }
        }

        // Quick Add Autocomplete Handlers
        function handleQuickAddressAutocomplete(input) {
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById('quick-address-dropdown');
            
            if (!dropdown) return;
            
            const isNumeric = /^\d/.test(value);
            
            const addresses = db.getAddresses().filter(a => {
                const streetWords = a.street.toLowerCase().split(' ');
                const suburbWords = a.suburb.toLowerCase().split(' ');
                const lotNumber = a.propertyNumber ? a.propertyNumber.toLowerCase() : '';
                
                if (isNumeric) {
                    return lotNumber.startsWith(value) ||
                           streetWords.some(word => word.startsWith(value));
                }
                
                return streetWords.some(word => word.startsWith(value)) || 
                       suburbWords.some(word => word.startsWith(value));
            }).sort((a, b) => {
                if (isNumeric) {
                    const aLotMatch = a.propertyNumber && a.propertyNumber.toLowerCase().startsWith(value);
                    const bLotMatch = b.propertyNumber && b.propertyNumber.toLowerCase().startsWith(value);
                    if (aLotMatch && !bLotMatch) return -1;
                    if (!aLotMatch && bLotMatch) return 1;
                    
                    const aStreetFirst = a.street.toLowerCase().split(' ')[0];
                    const bStreetFirst = b.street.toLowerCase().split(' ')[0];
                    const aStreetMatch = aStreetFirst.startsWith(value);
                    const bStreetMatch = bStreetFirst.startsWith(value);
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                } else {
                    const aStreetWords = a.street.toLowerCase().split(' ');
                    const bStreetWords = b.street.toLowerCase().split(' ');
                    
                    const aStreetMatch = aStreetWords.some(word => word.startsWith(value));
                    const bStreetMatch = bStreetWords.some(word => word.startsWith(value));
                    
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                    
                    if (aStreetMatch && bStreetMatch) {
                        const aFirstWord = aStreetWords[0].startsWith(value);
                        const bFirstWord = bStreetWords[0].startsWith(value);
                        if (aFirstWord && !bFirstWord) return -1;
                        if (!aFirstWord && bFirstWord) return 1;
                    }
                }
                return a.street.localeCompare(b.street);
            });
            
            if (addresses.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = addresses.slice(0, 5).map(a => `
                <div class="autocomplete-item" onclick="selectQuickAddress(${a.id}, '${a.street}, ${a.suburb}')">
                    ${a.street}, ${a.suburb}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectQuickAddress(id, text) {
            document.getElementById('quick-address-input').value = text;
            document.getElementById('quick-address-dropdown').classList.remove('active');
            state.selectedQuickAddress = id;
            
            // Auto-focus first defect input
            setTimeout(() => {
                const firstDefectInput = document.querySelector('.quick-defect-input');
                if (firstDefectInput) {
                    firstDefectInput.focus();
                }
            }, 100);
        }

        function handleQuickContractorAutocomplete(input) {
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById('quick-contractor-dropdown');
            
            if (!dropdown) return;
            
            const contractors = db.getContractors().filter(c => 
                {
                const nameWords = c.name.toLowerCase().split(' ');
                const tradesWords = c.trades ? c.trades.toLowerCase().split(' ') : [];
                return nameWords.some(word => word.startsWith(value)) ||
                       tradesWords.some(word => word.startsWith(value));
            });
            
            if (contractors.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = contractors.slice(0, 5).map(c => `
                <div class="autocomplete-item" onclick="selectQuickContractor(${c.id}, '${c.name.replace(/'/g, "\\'")}')">
                    ${c.name} - ${c.trades || 'No Trade'}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectQuickContractor(id, name) {
            document.getElementById('quick-contractor-input').value = name;
            document.getElementById('quick-contractor-dropdown').classList.remove('active');
            state.selectedQuickContractor = id;
            
            // Auto-focus first defect input
            setTimeout(() => {
                const firstDefectInput = document.querySelector('.quick-defect-input-address');
                if (firstDefectInput) {
                    firstDefectInput.focus();
                }
            }, 100);
        }

        // Add Defects Page Autocomplete Handlers
        function handleAddDefectsAddressAutocomplete(input) {
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById('add-defects-address-dropdown');
            
            if (!dropdown) return;
            
            const isNumeric = /^\d/.test(value);
            
            const addresses = db.getAddresses().filter(a => {
                const streetWords = a.street.toLowerCase().split(' ');
                const suburbWords = a.suburb.toLowerCase().split(' ');
                const lotNumber = a.propertyNumber ? a.propertyNumber.toLowerCase() : '';
                
                if (isNumeric) {
                    return lotNumber.startsWith(value) ||
                           streetWords.some(word => word.startsWith(value));
                }
                
                return streetWords.some(word => word.startsWith(value)) || 
                       suburbWords.some(word => word.startsWith(value));
            }).sort((a, b) => {
                if (isNumeric) {
                    const aLotMatch = a.propertyNumber && a.propertyNumber.toLowerCase().startsWith(value);
                    const bLotMatch = b.propertyNumber && b.propertyNumber.toLowerCase().startsWith(value);
                    if (aLotMatch && !bLotMatch) return -1;
                    if (!aLotMatch && bLotMatch) return 1;
                    
                    const aStreetFirst = a.street.toLowerCase().split(' ')[0];
                    const bStreetFirst = b.street.toLowerCase().split(' ')[0];
                    const aStreetMatch = aStreetFirst.startsWith(value);
                    const bStreetMatch = bStreetFirst.startsWith(value);
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                } else {
                    const aStreetWords = a.street.toLowerCase().split(' ');
                    const bStreetWords = b.street.toLowerCase().split(' ');
                    
                    const aStreetMatch = aStreetWords.some(word => word.startsWith(value));
                    const bStreetMatch = bStreetWords.some(word => word.startsWith(value));
                    
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                    
                    if (aStreetMatch && bStreetMatch) {
                        const aFirstWord = aStreetWords[0].startsWith(value);
                        const bFirstWord = bStreetWords[0].startsWith(value);
                        if (aFirstWord && !bFirstWord) return -1;
                        if (!aFirstWord && bFirstWord) return 1;
                    }
                }
                return a.street.localeCompare(b.street);
            });
            
            if (addresses.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = addresses.slice(0, 5).map(a => `
                <div class="autocomplete-item" onclick="selectAddDefectsAddress(${a.id}, '${a.street}, ${a.suburb}')">
                    ${a.street}, ${a.suburb}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectAddDefectsAddress(id, text) {
            document.getElementById('add-defects-address-input').value = text;
            document.getElementById('add-defects-address-dropdown').classList.remove('active');
            state.selectedAddDefectsAddress = id;
        }

        function handleAddDefectsContractorAutocomplete(input, contractorNum) {
            const value = input.value.toLowerCase();
            const dropdownId = contractorNum ? `add-contractor-${contractorNum}-dropdown` : 'add-defects-contractor-dropdown';
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) return;
            
            const contractors = db.getContractors().filter(c => 
                {
                const nameWords = c.name.toLowerCase().split(' ');
                const tradesWords = c.trades ? c.trades.toLowerCase().split(' ') : [];
                return nameWords.some(word => word.startsWith(value)) ||
                       tradesWords.some(word => word.startsWith(value));
            });
            
            if (contractors.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = contractors.slice(0, 5).map(c => `
                <div class="autocomplete-item" onclick="selectAddDefectsContractor(${c.id}, '${c.name.replace(/'/g, "\\'")}', ${contractorNum || 0})">
                    ${c.name} - ${c.trades || 'No Trade'}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectAddDefectsContractor(id, name, contractorNum) {
            if (contractorNum) {
                document.getElementById(`add-contractor-${contractorNum}-input`).value = name;
                document.getElementById(`add-contractor-${contractorNum}-dropdown`).classList.remove('active');
                if (!state.selectedAddDefectsContractors) state.selectedAddDefectsContractors = {};
                state.selectedAddDefectsContractors[contractorNum] = id;
            } else {
                document.getElementById('add-defects-contractor-input').value = name;
                document.getElementById('add-defects-contractor-dropdown').classList.remove('active');
                state.selectedAddDefectsContractor = id;
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('input[type="text"]')) {
                document.querySelectorAll('.autocomplete-dropdown').forEach(d => {
                    d.classList.remove('active');
                });
            }
        });

        // Add defects from view screen
        function openAddDefectsForContractor(contractorId) {
            state.currentContractorForAdd = contractorId;
            openModal('quick-add-defects-modal');
        }

        function openAddDefectsForAddress(addressId) {
            state.currentAddressForAdd = addressId;
            openModal('quick-add-defects-address-modal');
        }

        function saveQuickDefectsForContractor() {
            const contractorId = state.currentContractorForAdd;
            const addressInput = document.getElementById('quick-address-input');
            const defectInputs = document.querySelectorAll('.quick-defect-input');
            
            const addressId = state.selectedQuickAddress;
            if (!addressId || !addressInput.value.trim()) {
                showToast('Please select an address', true);
                return;
            }

            let savedCount = 0;
            defectInputs.forEach(input => {
                if (input.value.trim()) {
                    db.addDefect({
                        addressId,
                        contractorId,
                        description: input.value.trim()
                    });
                    savedCount++;
                }
            });

            if (savedCount > 0) {
                showToast(`${savedCount} defect(s) added successfully`);
                closeModal('quick-add-defects-modal');
                
                // Clear inputs
                addressInput.value = '';
                state.selectedQuickAddress = null;
                defectInputs.forEach(input => input.value = '');
                
                render();
            } else {
                showToast('Please enter at least one defect', true);
            }
        }

        function saveQuickDefectsForAddress() {
            const addressId = state.currentAddressForAdd;
            const contractorInput = document.getElementById('quick-contractor-input');
            const defectInputs = document.querySelectorAll('.quick-defect-input-address');
            
            const contractorId = state.selectedQuickContractor;
            if (!contractorId || !contractorInput.value.trim()) {
                showToast('Please select a contractor', true);
                return;
            }

            let savedCount = 0;
            defectInputs.forEach(input => {
                if (input.value.trim()) {
                    db.addDefect({
                        addressId,
                        contractorId,
                        description: input.value.trim()
                    });
                    savedCount++;
                }
            });

            if (savedCount > 0) {
                showToast(`${savedCount} defect(s) added successfully`);
                closeModal('quick-add-defects-address-modal');
                
                // Clear inputs
                contractorInput.value = '';
                state.selectedQuickContractor = null;
                defectInputs.forEach(input => input.value = '');
                
                render();
            } else {
                showToast('Please enter at least one defect', true);
            }
        }

        // Add Defects Page Save Functions
        function saveAddDefectsContractor() {
            const contractorId = state.filters.contractorId;
            const addressInput = document.getElementById('add-defects-address-input');
            const defectInputs = document.querySelectorAll('.add-defect-contractor-input');
            
            const addressId = state.selectedAddDefectsAddress;
            if (!addressId || !addressInput.value.trim()) {
                showToast('Please select an address', true);
                return;
            }

            let savedCount = 0;
            defectInputs.forEach(input => {
                if (input.value.trim()) {
                    db.addDefect({
                        addressId,
                        contractorId,
                        description: input.value.trim()
                    });
                    savedCount++;
                }
            });

            if (savedCount > 0) {
                showToast(`${savedCount} defect(s) added successfully`);
                
                // Clear inputs
                addressInput.value = '';
                state.selectedAddDefectsAddress = null;
                defectInputs.forEach(input => input.value = '');
                
                // Stay on page for more entries
                render();
            } else {
                showToast('Please enter at least one defect', true);
            }
        }

        function saveAddDefectsAddress() {
            const addressId = state.filters.addressId;
            let totalSaved = 0;
            
            // Process each contractor group
            for (let i = 1; i <= 5; i++) {
                const contractorInput = document.getElementById(`add-contractor-${i}-input`);
                if (!contractorInput || !contractorInput.value.trim()) continue;
                
                const contractorId = state.selectedAddDefectsContractors && state.selectedAddDefectsContractors[i];
                if (!contractorId) continue;
                
                // Get defects for this contractor
                const defectInputs = document.querySelectorAll(`.add-defect-${i}`);
                defectInputs.forEach(input => {
                    if (input.value.trim()) {
                        db.addDefect({
                            addressId,
                            contractorId,
                            description: input.value.trim()
                        });
                        totalSaved++;
                    }
                });
            }

            if (totalSaved > 0) {
                showToast(`✓ ${totalSaved} defect(s) added successfully`);
                
                // Clear all inputs
                for (let i = 1; i <= 5; i++) {
                    const contractorInput = document.getElementById(`add-contractor-${i}-input`);
                    if (contractorInput) contractorInput.value = '';
                    
                    const defectInputs = document.querySelectorAll(`.add-defect-${i}`);
                    defectInputs.forEach(input => input.value = '');
                }
                
                state.selectedAddDefectsContractors = {};
                
                // Stay on page for more entries
                render();
            } else {
                showToast('Please select at least one contractor and enter at least one defect', true);
            }
        }

        function addQuickDefectRow() {
            const container = document.getElementById('quick-defects-container');
            const row = document.createElement('div');
            row.className = 'defect-input-row';
            row.innerHTML = `
                <span>•</span>
                <input type="text" class="quick-defect-input" placeholder="Enter defect">
            `;
            container.appendChild(row);
        }

        function addQuickDefectRowAddress() {
            const container = document.getElementById('quick-defects-container-address');
            const row = document.createElement('div');
            row.className = 'defect-input-row';
            row.innerHTML = `
                <span>•</span>
                <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
            `;
            container.appendChild(row);
        }

        // Handle text file upload for bulk address import
        function handleAddressTextUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                let addedCount = 0;
                let skippedCount = 0;

                lines.forEach(line => {
                    const parts = line.trim().split(',').map(p => p.trim());
                    
                    if (parts.length >= 2) {
                        const street = parts[0];
                        const suburb = parts[1];
                        const propertyNumber = parts[2] || '';

                        // Check for duplicates
                        const exists = db.getAddresses().some(a => 
                            a.street.toLowerCase() === street.toLowerCase() && 
                            a.suburb.toLowerCase() === suburb.toLowerCase()
                        );

                        if (!exists) {
                            db.addAddress({ street, suburb, propertyNumber });
                            addedCount++;
                        } else {
                            skippedCount++;
                        }
                    }
                });

                closeModal('add-address-options-modal');
                
                if (addedCount > 0) {
                    showToast(`Added ${addedCount} address(es)${skippedCount > 0 ? `, skipped ${skippedCount} duplicate(s)` : ''}`);
                } else {
                    showToast('No new addresses added', true);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function saveSingleAddress() {
            const street = document.getElementById('single-address-street').value.trim();
            const suburb = document.getElementById('single-address-suburb').value.trim();
            const propertyNumber = document.getElementById('single-address-prop').value.trim();

            if (!street || !suburb) {
                showToast('Please enter street and suburb', true);
                return;
            }

            // Check for duplicates
            const exists = db.getAddresses().some(a => 
                a.street.toLowerCase() === street.toLowerCase() && 
                a.suburb.toLowerCase() === suburb.toLowerCase()
            );

            if (exists) {
                showToast('This address already exists', true);
                return;
            }

            db.addAddress({ street, suburb, propertyNumber });
            closeModal('add-address-options-modal');
            showToast('Address added successfully');
        }

        function saveCombinedAddresses() {
            const inputs = [
                document.getElementById('combined-address-1').value.trim(),
                document.getElementById('combined-address-2').value.trim(),
                document.getElementById('combined-address-3').value.trim()
            ].filter(val => val !== '');

            if (inputs.length === 0) {
                showToast('Please enter at least one address', true);
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            inputs.forEach(input => {
                const parts = input.split(',').map(p => p.trim());
                
                if (parts.length >= 2) {
                    const street = parts[0];
                    const suburb = parts[1];
                    const propertyNumber = parts[2] || '';

                    // Check for duplicates
                    const exists = db.getAddresses().some(a => 
                        a.street.toLowerCase() === street.toLowerCase() && 
                        a.suburb.toLowerCase() === suburb.toLowerCase()
                    );

                    if (!exists) {
                        db.addAddress({ street, suburb, propertyNumber });
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    errorCount++;
                }
            });

            closeModal('add-address-options-modal');
            
            // Clear inputs
            document.getElementById('combined-address-1').value = '';
            document.getElementById('combined-address-2').value = '';
            document.getElementById('combined-address-3').value = '';

            if (addedCount > 0) {
                let message = `Added ${addedCount} address(es)`;
                if (skippedCount > 0) message += `, skipped ${skippedCount} duplicate(s)`;
                if (errorCount > 0) message += `, ${errorCount} invalid format(s)`;
                showToast(message);
            } else if (skippedCount > 0) {
                showToast('All addresses already exist', true);
            } else if (errorCount > 0) {
                showToast('Invalid format. Use: Street, Suburb, Property Number', true);
            }
        }

        function saveCombinedTrades() {
            const inputs = [
                document.getElementById('combined-trade-1').value.trim(),
                document.getElementById('combined-trade-2').value.trim(),
                document.getElementById('combined-trade-3').value.trim(),
                document.getElementById('combined-trade-4').value.trim(),
                document.getElementById('combined-trade-5').value.trim()
            ].filter(val => val !== '');

            if (inputs.length === 0) {
                showToast('Please enter at least one trade', true);
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;

            inputs.forEach(tradeName => {
                // Check for duplicates
                const exists = db.getTrades().some(t => 
                    t.name.toLowerCase() === tradeName.toLowerCase()
                );

                if (!exists) {
                    db.addTrade({ name: tradeName });
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            closeModal('add-trade-options-modal');
            
            // Clear inputs
            document.getElementById('combined-trade-1').value = '';
            document.getElementById('combined-trade-2').value = '';
            document.getElementById('combined-trade-3').value = '';
            document.getElementById('combined-trade-4').value = '';
            document.getElementById('combined-trade-5').value = '';

            if (addedCount > 0) {
                let message = `Added ${addedCount} trade(s)`;
                if (skippedCount > 0) message += `, skipped ${skippedCount} duplicate(s)`;
                showToast(message);
                render();
            } else if (skippedCount > 0) {
                showToast('All trades already exist', true);
            }
        }

        function saveCombinedContractors() {
            const inputs = [
                document.getElementById('combined-contractor-1').value.trim(),
                document.getElementById('combined-contractor-2').value.trim(),
                document.getElementById('combined-contractor-3').value.trim()
            ].filter(val => val !== '');

            if (inputs.length === 0) {
                showToast('Please enter at least one contractor', true);
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            inputs.forEach(input => {
                const parts = input.split(',').map(p => p.trim());
                
                if (parts.length >= 1) {
                    const name = parts[0];
                    const email = parts[1] && parts[1].includes('@') ? parts[1] : '';
                    const phone = parts[2] || (parts[1] && !parts[1].includes('@') ? parts[1] : '');
                    
                    // Trade names start after name, email, phone
                    const startIdx = email && phone ? 3 : (email || phone ? 2 : 1);
                    const tradeNames = parts.slice(startIdx);
                    
                    // Find trade IDs
                    const tradeIds = [];
                    tradeNames.forEach(tradeName => {
                        const trade = db.getTrades().find(t => 
                            t.name.toLowerCase() === tradeName.toLowerCase()
                        );
                        if (trade) {
                            tradeIds.push(trade.id);
                        }
                    });

                    // Check for duplicates
                    const exists = db.getContractors().some(c => 
                        c.name.toLowerCase() === name.toLowerCase()
                    );

                    if (!exists) {
                        db.addContractor({ name, email, phone, tradeIds });
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    errorCount++;
                }
            });

            closeModal('add-contractor-options-modal');
            
            // Clear inputs
            document.getElementById('combined-contractor-1').value = '';
            document.getElementById('combined-contractor-2').value = '';
            document.getElementById('combined-contractor-3').value = '';

            if (addedCount > 0) {
                let message = `Added ${addedCount} contractor(s)`;
                if (skippedCount > 0) message += `, skipped ${skippedCount} duplicate(s)`;
                if (errorCount > 0) message += `, ${errorCount} invalid format(s)`;
                showToast(message);
                render();
            } else if (skippedCount > 0) {
                showToast('All contractors already exist', true);
            } else if (errorCount > 0) {
                showToast('Invalid format. Use: Name, Email, Phone, Trade1, Trade2', true);
            }
        }

        function handleTradeTextUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                let addedCount = 0;
                let skippedCount = 0;

                lines.forEach(line => {
                    const tradeName = line.trim();
                    
                    if (tradeName) {
                        // Check for duplicates
                        const exists = db.getTrades().some(t => 
                            t.name.toLowerCase() === tradeName.toLowerCase()
                        );

                        if (!exists) {
                            db.addTrade({ name: tradeName });
                            addedCount++;
                        } else {
                            skippedCount++;
                        }
                    }
                });

                closeModal('add-trade-options-modal');
                
                if (addedCount > 0) {
                    showToast(`Added ${addedCount} trade(s)${skippedCount > 0 ? `, skipped ${skippedCount} duplicate(s)` : ''}`);
                    render();
                } else {
                    showToast('No new trades added', true);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function handleContractorTextUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                let addedCount = 0;
                let skippedCount = 0;

                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    
                    if (parts.length >= 1) {
                        const name = parts[0];
                        const tradeNames = parts.slice(1);
                        
                        // Find trade IDs
                        const tradeIds = [];
                        tradeNames.forEach(tradeName => {
                            const trade = db.getTrades().find(t => 
                                t.name.toLowerCase() === tradeName.toLowerCase()
                            );
                            if (trade) {
                                tradeIds.push(trade.id);
                            }
                        });

                        // Check for duplicates
                        const exists = db.getContractors().some(c => 
                            c.name.toLowerCase() === name.toLowerCase()
                        );

                        if (!exists) {
                            db.addContractor({ name, tradeIds });
                            addedCount++;
                        } else {
                            skippedCount++;
                        }
                    }
                });

                closeModal('add-contractor-options-modal');
                
                if (addedCount > 0) {
                    showToast(`Added ${addedCount} contractor(s)${skippedCount > 0 ? `, skipped ${skippedCount} duplicate(s)` : ''}`);
                    render();
                } else {
                    showToast('No new contractors added', true);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function addDefectsByAddress() {
            const input = document.getElementById('add-address').value;
            const address = db.getAddresses().find(a => 
                a.street.toLowerCase().includes(input.toLowerCase())
            );
            if (address) {
                state.currentView = 'add-defects-address';
                state.filters = { addressId: address.id };
                render();
                initializeAddressDefectForm();
            }
        }

        function addDefectsByContractor() {
            const input = document.getElementById('add-contractor').value;
            const contractor = db.getContractors().find(c => 
                c.name.toLowerCase().includes(input.toLowerCase())
            );
            if (contractor) {
                state.currentView = 'add-defects-contractor';
                state.filters = { contractorId: contractor.id };
                render();
                initializeContractorDefectForm();
            }
        }

        function searchMultipleContractors() {
            const contractor1 = document.getElementById('multi-contractor-1').value.trim();
            const contractor2 = document.getElementById('multi-contractor-2').value.trim();
            const contractor3 = document.getElementById('multi-contractor-3').value.trim();
            
            const contractorIds = [];
            
            // Find contractor IDs for each filled field
            [contractor1, contractor2, contractor3].forEach(name => {
                if (name) {
                    const contractor = db.getContractors().find(c => 
                        c.name.toLowerCase().includes(name.toLowerCase())
                    );
                    if (contractor) {
                        contractorIds.push(contractor.id);
                    }
                }
            });
            
            if (contractorIds.length === 0) {
                showToast('Please enter at least one contractor', true);
                return;
            }
            
            state.currentView = 'view-multiple-contractors';
            state.filters = { contractorIds };
            render();
        }

        function searchMultipleTrades() {
            const trade1 = document.getElementById('multi-trade-1').value.trim();
            const trade2 = document.getElementById('multi-trade-2').value.trim();
            const trade3 = document.getElementById('multi-trade-3').value.trim();
            
            const tradeIds = [];
            
            // Find trade IDs for each filled field
            [trade1, trade2, trade3].forEach(name => {
                if (name) {
                    const trade = db.getTrades().find(t => 
                        t.name.toLowerCase().includes(name.toLowerCase())
                    );
                    if (trade) {
                        tradeIds.push(trade.id);
                    }
                }
            });
            
            if (tradeIds.length === 0) {
                showToast('Please enter at least one trade', true);
                return;
            }
            
            // Get all contractors with any of the selected trades
            const contractorIds = [];
            db.getContractors().forEach(contractor => {
                if (contractor.tradeIds && contractor.tradeIds.some(tid => tradeIds.includes(tid))) {
                    contractorIds.push(contractor.id);
                }
            });
            
            if (contractorIds.length === 0) {
                showToast('No contractors found for selected trades', true);
                return;
            }
            
            state.currentView = 'view-multiple-contractors';
            state.filters = { contractorIds };
            render();
        }

        function toggleDefectComplete(defectId) {
            db.markDefectComplete(defectId);
            render();
            showToast('Defect marked as complete');
        }

        function exportDefects() {
            const text = db.exportToText();
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate smart filename based on current view
            let filename = 'defects';
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            
            if (state.currentView === 'view-defects-address' && state.filters.addressId) {
                const address = db.getAddress(state.filters.addressId);
                const lot = address.propertyNumber || 'XXX';
                const streetPrefix = address.street.replace(/\s+/g, '').substring(0, 5);
                filename = `Lot${lot}_${streetPrefix}_${today}.txt`;
            } else if (state.currentView === 'view-defects-contractor' && state.filters.contractorId) {
                const contractor = db.getContractor(state.filters.contractorId);
                const contractorPrefix = contractor.name.replace(/\s+/g, '').substring(0, 5);
                filename = `Contractor_${contractorPrefix}_${today}.txt`;
            } else if (state.currentView === 'view-multiple-contractors' && state.filters.contractorIds) {
                filename = `MultipleContractors_${today}.txt`;
            } else {
                filename = `AllDefects_${today}.txt`;
            }
            
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Exported to ' + filename);
        }

        function copyDefectsToClipboard() {
            let textContent = '';
            
            // Build text content based on current view context
            if (state.currentView === 'view-defects-contractor' && state.filters.contractorId) {
                // Contractor view - get all defects for this contractor
                const contractor = db.getContractor(state.filters.contractorId);
                const defectGroups = db.getDefectsByAddress({ contractorId: state.filters.contractorId });
                
                textContent = `${contractor.name}\n\n`;
                defectGroups.forEach(group => {
                    textContent += `${group.address.street}\n`;
                    group.defects.forEach(defect => {
                        textContent += `  • ${defect.description}\n`;
                    });
                    textContent += '\n';
                });
            } else if (state.currentView === 'view-defects-address' && state.filters.addressId) {
                // Address view - get all defects for this address
                const address = db.getAddress(state.filters.addressId);
                const defects = db.getDefects({ addressId: state.filters.addressId });
                
                // Group by contractor
                const byContractor = {};
                defects.forEach(d => {
                    if (!byContractor[d.contractorId]) {
                        const contractor = db.getContractor(d.contractorId);
                        byContractor[d.contractorId] = {
                            contractorName: contractor ? contractor.name : 'Unknown Contractor',
                            defects: []
                        };
                    }
                    byContractor[d.contractorId].defects.push(d);
                });
                
                textContent = `Lot ${address.propertyNumber} [${address.street.split(' ')[0]}] ${address.street}, ${address.suburb}\n\n`;
                Object.values(byContractor).forEach(group => {
                    textContent += `${group.contractorName}\n`;
                    group.defects.forEach(defect => {
                        textContent += `  • ${defect.description}\n`;
                    });
                    textContent += '\n';
                });
            } else if (state.currentView === 'view-defects-trade' && state.filters) {
                // Trade view - get defects from contractors with this trade
                const { tradeName, contractorIds } = state.filters;
                const defects = db.getDefects().filter(d => contractorIds.includes(d.contractorId));
                
                // Group by contractor, then by address
                const byContractor = {};
                defects.forEach(d => {
                    if (!byContractor[d.contractorId]) {
                        byContractor[d.contractorId] = {
                            contractor: db.getContractor(d.contractorId),
                            addresses: {}
                        };
                    }
                    if (!byContractor[d.contractorId].addresses[d.addressId]) {
                        byContractor[d.contractorId].addresses[d.addressId] = {
                            address: db.getAddress(d.addressId),
                            defects: []
                        };
                    }
                    byContractor[d.contractorId].addresses[d.addressId].defects.push(d);
                });
                
                textContent = `${tradeName}\n\n`;
                Object.values(byContractor).forEach(contractorGroup => {
                    textContent += `${contractorGroup.contractor.name}\n`;
                    Object.values(contractorGroup.addresses).forEach(addressGroup => {
                        textContent += `  ${addressGroup.address.street}, ${addressGroup.address.suburb}\n`;
                        addressGroup.defects.forEach(defect => {
                            textContent += `    • ${defect.description}\n`;
                        });
                    });
                    textContent += '\n';
                });
            } else {
                // Fallback - export everything
                textContent = db.exportToText();
            }
            
            // Use modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textContent)
                    .then(() => {
                        showToast('📋 Copied to clipboard!');
                    })
                    .catch(err => {
                        // Fallback to older method
                        fallbackCopyToClipboard(textContent);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopyToClipboard(textContent);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('📋 Copied to clipboard!');
            } catch (err) {
                showToast('Failed to copy to clipboard', true);
            }
            
            document.body.removeChild(textarea);
        }

        function emailDefectList() {
            let textContent = '';
            let subject = 'Defect List';
            let recipient = '';
            
            // Build content based on current view context (same as copy function)
            if (state.currentView === 'view-defects-contractor' && state.filters.contractorId) {
                const contractor = db.getContractor(state.filters.contractorId);
                const defectGroups = db.getDefectsByAddress({ contractorId: state.filters.contractorId });
                
                subject = `Defect List - ${contractor.name}`;
                if (contractor.email) {
                    recipient = contractor.email;
                }
                
                textContent = `${contractor.name}\n\n`;
                defectGroups.forEach(group => {
                    textContent += `${group.address.street}\n`;
                    group.defects.forEach(defect => {
                        textContent += `  • ${defect.description}\n`;
                    });
                    textContent += '\n';
                });
            } else if (state.currentView === 'view-defects-address' && state.filters.addressId) {
                const address = db.getAddress(state.filters.addressId);
                const defects = db.getDefects({ addressId: state.filters.addressId });
                
                subject = `Defect List - Lot ${address.propertyNumber}, ${address.street}`;
                
                // Collect all contractor emails
                const contractorEmails = [];
                const byContractor = {};
                defects.forEach(d => {
                    if (!byContractor[d.contractorId]) {
                        const contractor = db.getContractor(d.contractorId);
                        byContractor[d.contractorId] = {
                            contractorName: contractor ? contractor.name : 'Unknown Contractor',
                            defects: []
                        };
                        // Add email if it exists
                        if (contractor && contractor.email && contractor.email.trim()) {
                            contractorEmails.push(contractor.email.trim());
                        }
                    }
                    byContractor[d.contractorId].defects.push(d);
                });
                
                // Set recipient to all contractor emails (separated by semicolons)
                recipient = contractorEmails.join('; ');
                
                textContent = `Lot ${address.propertyNumber} [${address.street.split(' ')[0]}] ${address.street}, ${address.suburb}\n\n`;
                Object.values(byContractor).forEach(group => {
                    textContent += `${group.contractorName}\n`;
                    group.defects.forEach(defect => {
                        textContent += `  • ${defect.description}\n`;
                    });
                    textContent += '\n';
                });
            } else if (state.currentView === 'view-defects-trade' && state.filters) {
                const { tradeName, contractorIds } = state.filters;
                const defects = db.getDefects().filter(d => contractorIds.includes(d.contractorId));
                
                subject = `Defect List - ${tradeName}`;
                
                const byContractor = {};
                defects.forEach(d => {
                    if (!byContractor[d.contractorId]) {
                        byContractor[d.contractorId] = {
                            contractor: db.getContractor(d.contractorId),
                            addresses: {}
                        };
                    }
                    if (!byContractor[d.contractorId].addresses[d.addressId]) {
                        byContractor[d.contractorId].addresses[d.addressId] = {
                            address: db.getAddress(d.addressId),
                            defects: []
                        };
                    }
                    byContractor[d.contractorId].addresses[d.addressId].defects.push(d);
                });
                
                textContent = `${tradeName}\n\n`;
                Object.values(byContractor).forEach(contractorGroup => {
                    textContent += `${contractorGroup.contractor.name}\n`;
                    Object.values(contractorGroup.addresses).forEach(addressGroup => {
                        textContent += `  ${addressGroup.address.street}, ${addressGroup.address.suburb}\n`;
                        addressGroup.defects.forEach(defect => {
                            textContent += `    • ${defect.description}\n`;
                        });
                    });
                    textContent += '\n';
                });
            } else {
                textContent = db.exportToText();
            }
            
            // Create mailto link
            const mailtoLink = recipient 
                ? `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textContent)}`
                : `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(textContent)}`;
            
            window.location.href = mailtoLink;
            showToast('📧 Opening email client...');
        }

        function refreshDefects() {
            render();
            showToast('Defects refreshed');
        }

        // Contact Info Editing Functions
        let currentEditingContractorId = null;

        function openEditContactModal(contractorId) {
            currentEditingContractorId = contractorId;
            const contractor = db.getContractor(contractorId);
            
            if (contractor) {
                document.getElementById('modal-edit-email').value = contractor.email || '';
                document.getElementById('modal-edit-phone').value = contractor.phone || '';
                openModal('edit-contact-modal');
            }
        }

        function saveContactInfoFromModal() {
            if (!currentEditingContractorId) return;
            
            const newEmail = document.getElementById('modal-edit-email').value.trim();
            const newPhone = document.getElementById('modal-edit-phone').value.trim();
            
            const contractor = db.getContractor(currentEditingContractorId);
            if (contractor) {
                contractor.email = newEmail;
                contractor.phone = newPhone;
                db.save();
                
                closeModal('edit-contact-modal');
                showToast('✓ Contact info updated successfully');
                render(); // Re-render to show updated info
            }
        }

        function showManageScreen() {
            state.currentView = 'manage';
            render();
        }

        function showHomeView() {
            state.currentView = 'home';
            state.filters = {};
            render();
        }

        function initializeAddressDefectForm() {
            const container = document.getElementById('contractor-groups-container');
            container.innerHTML = `
                <div class="contractor-group" id="group-0">
                    <div class="autocomplete-container" style="margin-bottom: 15px;">
                        <input type="text" class="contractor-input" placeholder="Select Contractor..." 
                               style="width: 100%; padding: 12px 15px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;"
                               oninput="handleContractorAutocomplete(this, 0)"
                               onfocus="handleContractorAutocomplete(this, 0)">
                        <div id="contractor-dropdown-0" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="defects-container">
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                    </div>
                </div>
            `;
        }

        function handleContractorAutocomplete(input, groupIndex) {
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById(`contractor-dropdown-${groupIndex}`);
            
            if (!dropdown) return;
            
            const contractors = db.getContractors().filter(c => 
                {
                const nameWords = c.name.toLowerCase().split(' ');
                const tradesWords = c.trades ? c.trades.toLowerCase().split(' ') : [];
                return nameWords.some(word => word.startsWith(value)) ||
                       tradesWords.some(word => word.startsWith(value));
            });
            
            if (contractors.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = contractors.slice(0, 5).map(c => `
                <div class="autocomplete-item" onclick="selectContractorForGroup(${groupIndex}, ${c.id}, '${c.name.replace(/'/g, "\\'")}')">
                    ${c.name} - ${c.trades || 'No Trade'}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectContractorForGroup(groupIndex, contractorId, contractorName) {
            const input = document.querySelector(`#group-${groupIndex} .contractor-input`);
            const dropdown = document.getElementById(`contractor-dropdown-${groupIndex}`);
            
            if (input) {
                input.value = contractorName;
                input.setAttribute('data-contractor-id', contractorId);
            }
            if (dropdown) dropdown.classList.remove('active');
        }

        function initializeContractorDefectForm() {
            const container = document.getElementById('address-groups-container');
            container.innerHTML = `
                <div class="contractor-group" id="address-group-0">
                    <div class="autocomplete-container" style="margin-bottom: 15px;">
                        <input type="text" class="address-input" placeholder="Select Address..." 
                               style="width: 100%; padding: 12px 15px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;"
                               oninput="handleAddressAutocomplete(this, 0)"
                               onfocus="handleAddressAutocomplete(this, 0)">
                        <div id="address-dropdown-0" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="defects-container">
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                        <div class="defect-input-row">
                            <span>*</span>
                            <input type="text" placeholder="enter defect">
                        </div>
                    </div>
                </div>
            `;
        }

        function handleAddressAutocomplete(input, groupIndex) {
            const value = input.value.toLowerCase();
            const dropdown = document.getElementById(`address-dropdown-${groupIndex}`);
            
            if (!dropdown) return;
            
            const isNumeric = /^\d/.test(value);
            
            const addresses = db.getAddresses().filter(a => {
                const streetWords = a.street.toLowerCase().split(' ');
                const suburbWords = a.suburb.toLowerCase().split(' ');
                const lotNumber = a.propertyNumber ? a.propertyNumber.toLowerCase() : '';
                
                if (isNumeric) {
                    return lotNumber.startsWith(value) ||
                           streetWords.some(word => word.startsWith(value));
                }
                
                return streetWords.some(word => word.startsWith(value)) || 
                       suburbWords.some(word => word.startsWith(value));
            }).sort((a, b) => {
                if (isNumeric) {
                    const aLotMatch = a.propertyNumber && a.propertyNumber.toLowerCase().startsWith(value);
                    const bLotMatch = b.propertyNumber && b.propertyNumber.toLowerCase().startsWith(value);
                    if (aLotMatch && !bLotMatch) return -1;
                    if (!aLotMatch && bLotMatch) return 1;
                    
                    const aStreetFirst = a.street.toLowerCase().split(' ')[0];
                    const bStreetFirst = b.street.toLowerCase().split(' ')[0];
                    const aStreetMatch = aStreetFirst.startsWith(value);
                    const bStreetMatch = bStreetFirst.startsWith(value);
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                } else {
                    const aStreetWords = a.street.toLowerCase().split(' ');
                    const bStreetWords = b.street.toLowerCase().split(' ');
                    
                    const aStreetMatch = aStreetWords.some(word => word.startsWith(value));
                    const bStreetMatch = bStreetWords.some(word => word.startsWith(value));
                    
                    if (aStreetMatch && !bStreetMatch) return -1;
                    if (!aStreetMatch && bStreetMatch) return 1;
                    
                    if (aStreetMatch && bStreetMatch) {
                        const aFirstWord = aStreetWords[0].startsWith(value);
                        const bFirstWord = bStreetWords[0].startsWith(value);
                        if (aFirstWord && !bFirstWord) return -1;
                        if (!aFirstWord && bFirstWord) return 1;
                    }
                }
                return a.street.localeCompare(b.street);
            });
            
            if (addresses.length === 0 || value === '') {
                dropdown.classList.remove('active');
                return;
            }
            
            dropdown.innerHTML = addresses.slice(0, 5).map(a => `
                <div class="autocomplete-item" onclick="selectAddressForGroup(${groupIndex}, ${a.id}, '${a.street.replace(/'/g, "\\'")}')">
                    ${a.street}, ${a.suburb}
                </div>
            `).join('');
            
            dropdown.classList.add('active');
        }

        function selectAddressForGroup(groupIndex, addressId, street) {
            const input = document.querySelector(`#address-group-${groupIndex} .address-input`);
            const dropdown = document.getElementById(`address-dropdown-${groupIndex}`);
            
            if (input) {
                input.value = street;
                input.setAttribute('data-address-id', addressId);
            }
            if (dropdown) dropdown.classList.remove('active');
        }

        function saveAddresssDefects() {
            const addressId = state.filters.addressId;
            const groups = document.querySelectorAll('.contractor-group');
            let savedCount = 0;

            groups.forEach(group => {
                const contractorInput = group.querySelector('.contractor-input');
                const contractorId = contractorInput ? parseInt(contractorInput.getAttribute('data-contractor-id')) : null;
                
                if (!contractorId) return;

                const inputs = group.querySelectorAll('input[type="text"]:not(.contractor-input)');
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        db.addDefect({
                            addressId,
                            contractorId,
                            description: input.value.trim()
                        });
                        savedCount++;
                        input.value = '';
                    }
                });
            });

            if (savedCount > 0) {
                showToast(`${savedCount} defects added successfully`);
                initializeAddressDefectForm();
            } else {
                showToast('Please select a contractor and enter at least one defect', true);
            }
        }

        function saveContractorDefects() {
            const contractorId = state.filters.contractorId;
            const groups = document.querySelectorAll('.contractor-group');
            let savedCount = 0;

            groups.forEach(group => {
                const addressInput = group.querySelector('.address-input');
                const addressId = addressInput ? parseInt(addressInput.getAttribute('data-address-id')) : null;
                
                if (!addressId) return;

                const inputs = group.querySelectorAll('input[type="text"]:not(.address-input)');
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        db.addDefect({
                            addressId,
                            contractorId,
                            description: input.value.trim()
                        });
                        savedCount++;
                        input.value = '';
                    }
                });
            });

            if (savedCount > 0) {
                showToast(`${savedCount} defects added successfully`);
                initializeContractorDefectForm();
            } else {
                showToast('Please select an address and enter at least one defect', true);
            }
        }

        // Manage modals
        function createModals() {
            return `
                <!-- Quick Add Defects for Contractor Modal -->
                <div id="quick-add-defects-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Defects</span>
                            <button onclick="event.target.closest('.modal').style.display='none'" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <!-- Save Button at Top -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="saveQuickDefectsForContractor()" style="padding: 12px 40px; font-size: 17px; font-weight: 600;">
                                💾 Save Defects
                            </button>
                        </div>

                        <div class="input-group">
                            <label>Select Address:</label>
                            <div class="autocomplete-container" style="position: relative;">
                                <input type="text" 
                                       id="quick-address-input" 
                                       placeholder="Start typing address..." 
                                       oninput="handleQuickAddressAutocomplete(this)"
                                       onfocus="handleQuickAddressAutocomplete(this)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="quick-address-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Defects:</label>
                            <div id="quick-defects-container">
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input" placeholder="Enter defect">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Defects for Address Modal -->
                <div id="quick-add-defects-address-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Defects</span>
                            <button onclick="event.target.closest('.modal').style.display='none'" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <!-- Save Button at Top -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="saveQuickDefectsForAddress()" style="padding: 12px 40px; font-size: 17px; font-weight: 600;">
                                💾 Save Defects
                            </button>
                        </div>

                        <div class="input-group">
                            <label>Select Contractor:</label>
                            <div class="autocomplete-container" style="position: relative;">
                                <input type="text" 
                                       id="quick-contractor-input" 
                                       placeholder="Start typing contractor name..." 
                                       oninput="handleQuickContractorAutocomplete(this)"
                                       onfocus="handleQuickContractorAutocomplete(this)"
                                       style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                                <div id="quick-contractor-dropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Defects:</label>
                            <div id="quick-defects-container-address">
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                                <div class="defect-input-row">
                                    <span>•</span>
                                    <input type="text" class="quick-defect-input-address" placeholder="Enter defect">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Address Options Modal -->
                <div id="add-address-options-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Addresses</span>
                            <button onclick="closeModal('add-address-options-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Add Addresses (up to 3)</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Format: <strong>Street, Suburb, Property Number</strong>
                            </p>
                            <div class="input-group">
                                <input type="text" id="combined-address-1" placeholder="123 Main Street, Werribee, 3484" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-address-2" placeholder="456 Second Ave, Point Cook, 5678" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-address-3" placeholder="789 Third Road, Werribee, 9012">
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="saveCombinedAddresses()">Add Address(es)</button>
                        </div>

                        <div style="border-top: 1px solid #e5e5ea; padding-top: 20px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Upload Text File</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Upload a .txt file with one address per line:<br>
                                Format: <strong>Street, Suburb, Property Number</strong><br>
                                Example: <em>123 Main St, Werribee, 3484</em>
                            </p>
                            <input type="file" id="address-text-upload" accept=".txt" style="display: none;" onchange="handleAddressTextUpload(event)">
                            <button class="btn btn-secondary" style="width: 100%;" onclick="document.getElementById('address-text-upload').click()">
                                📄 Choose Text File
                            </button>
                        </div>

                        <div class="modal-actions" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('add-address-options-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- All Addresses List Modal -->
                <div id="all-addresses-list-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>All Addresses</span>
                            <button onclick="closeModal('all-addresses-list-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${db.getAddresses().map(a => `
                                <div class="defect-item" style="cursor: pointer; background: var(--bg-primary); margin-bottom: 3px; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px;" 
                                     onclick="selectAddressFromList(${a.id})">
                                    <div style="font-weight: 600; font-size: 16px;">${a.street}</div>
                                    <div style="font-size: 14px; font-weight: 400; color: #666;">${a.suburb} • Lot ${a.propertyNumber}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('all-addresses-list-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- All Contractors List Modal -->
                <div id="all-contractors-list-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>All Contractors</span>
                            <button onclick="closeModal('all-contractors-list-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${db.getContractors().map(c => `
                                <div class="defect-item" style="background: var(--bg-primary); margin-bottom: 3px; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                        <div style="flex: 1; cursor: pointer;" onclick="selectContractorFromList(${c.id})">
                                            <div style="font-weight: 600; font-size: 15px;">${c.name}</div>
                                            <div style="font-size: 13px; color: ${(!c.tradeIds || c.tradeIds.length === 0) ? '#FF3B30' : '#8e8e93'}; margin-top: 2px;">
                                                ${c.trades || '⚠️ No Trade Assigned'}
                                            </div>
                                            ${c.email ? `<div style="font-size: 12px; color: #8e8e93; margin-top: 2px;">📧 ${c.email}</div>` : ''}
                                            ${c.phone ? `<div style="font-size: 12px; color: #8e8e93; margin-top: 2px;">📞 ${c.phone}</div>` : ''}
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 5px;">
                                            ${c.phone ? `<button onclick="callContractor('${c.phone}', event)" style="background: #34C759; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 13px; cursor: pointer; white-space: nowrap;">📞 Call</button>` : ''}
                                            ${c.email ? `<button onclick="emailContractor('${c.email}', '${c.name}', event)" style="background: #007AFF; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 13px; cursor: pointer; white-space: nowrap;">📧 Email</button>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('all-contractors-list-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- All Trades List Modal -->
                <div id="all-trades-list-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>All Trades</span>
                            <button onclick="closeModal('all-trades-list-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${(() => {
                                const unassignedCount = db.getContractors().filter(c => !c.tradeIds || c.tradeIds.length === 0).length;
                                let html = '';
                                
                                // Add unassigned contractors option if any exist
                                if (unassignedCount > 0) {
                                    html += `
                                        <div class="defect-item" style="cursor: pointer; background: #FFF3CD; margin-bottom: 5px; padding: 8px 12px; border: 2px solid #FF9800; border-radius: 8px;" 
                                             onclick="showUnassignedContractors()">
                                            <div style="font-weight: 600; color: #FF6B00;">⚠️ Unassigned Contractors</div>
                                            <div style="font-size: 13px; color: #8e8e93;">${unassignedCount} contractor(s) without trade</div>
                                        </div>
                                    `;
                                }
                                
                                // Sort trades by code number (ascending) and exclude hidden
                                const sortedTrades = db.getTrades(false).sort((a, b) => {
                                    const codeA = parseInt(a.code) || 0;
                                    const codeB = parseInt(b.code) || 0;
                                    return codeA - codeB;
                                });
                                
                                // Add all trades with proper code display
                                html += sortedTrades.map(t => {
                                    const contractorCount = db.getContractors().filter(c => c.tradeIds && c.tradeIds.includes(t.id)).length;
                                    const tradeCode = t.code || '';
                                    return `
                                        <div class="defect-item" style="cursor: pointer; background: var(--bg-primary); margin-bottom: 1px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;" 
                                             onclick="showContractorsForTrade(${t.id})">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; font-size: 15px; line-height: 1.3;">${t.name}</div>
                                                    <div style="font-size: 12px; color: #8e8e93; margin-top: 2px;">${contractorCount} contractor(s)</div>
                                                </div>
                                                ${tradeCode ? `<div style="font-weight: 600; color: var(--blue); font-size: 15px; flex-shrink: 0; line-height: 1.3;">${tradeCode}</div>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                                
                                return html;
                            })()}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('all-trades-list-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Contractors by Trade Modal -->
                <div id="contractors-by-trade-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" id="trade-modal-header">Contractors</div>
                        <div id="contractors-by-trade-list" style="max-height: 400px; overflow-y: auto;">
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('contractors-by-trade-modal'); openModal('all-trades-list-modal');">Back</button>
                        </div>
                    </div>
                </div>

                <!-- Add Address Modal -->
                <div id="add-address-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Job Address</span>
                            <button onclick="closeModal('add-address-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div class="input-group">
                            <label>Street Address:</label>
                            <input type="text" id="new-address-street" placeholder="123 Main Street">
                        </div>
                        <div class="input-group">
                            <label>Suburb:</label>
                            <input type="text" id="new-address-suburb" placeholder="Werribee">
                        </div>
                        <div class="input-group">
                            <label>Property Number:</label>
                            <input type="text" id="new-address-prop" placeholder="3484">
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('add-address-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveAddress()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Delete Address Modal -->
                <div id="delete-address-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Delete Job Address</span>
                            <button onclick="closeModal('delete-address-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <select id="delete-address-select" style="width: 100%; padding: 10px; margin-bottom: 20px;">
                            <option value="">Select address to delete...</option>
                            ${db.getAddresses().map(a => 
                                `<option value="${a.id}">${a.street}</option>`
                            ).join('')}
                        </select>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('delete-address-modal')">Cancel</button>
                            <button class="btn btn-danger" onclick="confirmDeleteAddress()">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Add Trade Options Modal -->
                <div id="add-trade-options-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Trades</span>
                            <button onclick="closeModal('add-trade-options-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Add Trades (up to 5)</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Enter trade names (one per field)
                            </p>
                            <div class="input-group">
                                <input type="text" id="combined-trade-1" placeholder="Carpenter" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-trade-2" placeholder="Electrician" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-trade-3" placeholder="Plumber" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-trade-4" placeholder="Painter" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-trade-5" placeholder="Tiler">
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="saveCombinedTrades()">Add Trade(s)</button>
                        </div>

                        <div style="border-top: 1px solid #e5e5ea; padding-top: 20px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Upload Text File</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Upload a .txt file with one trade per line:<br>
                                Example: <em>Carpenter</em>
                            </p>
                            <input type="file" id="trade-text-upload" accept=".txt" style="display: none;" onchange="handleTradeTextUpload(event)">
                            <button class="btn btn-secondary" style="width: 100%;" onclick="document.getElementById('trade-text-upload').click()">
                                📄 Choose Text File
                            </button>
                        </div>

                        <div class="modal-actions" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('add-trade-options-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Add Contractor Options Modal -->
                <div id="add-contractor-options-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Contractors</span>
                            <button onclick="closeModal('add-contractor-options-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Add Contractors (up to 3)</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Format: <strong>Name, Email, Phone, Trade1, Trade2</strong><br>
                                (Email and phone are optional)
                            </p>
                            <div class="input-group">
                                <input type="text" id="combined-contractor-1" placeholder="John Smith, john@email.com, 0412345678, Carpenter" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-contractor-2" placeholder="ABC Construction, abc@email.com, 0423456789, Carpenter, Painter" style="margin-bottom: 10px;">
                            </div>
                            <div class="input-group">
                                <input type="text" id="combined-contractor-3" placeholder="Elite Plumbing, , 0434567890, Plumber">
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="saveCombinedContractors()">Add Contractor(s)</button>
                        </div>

                        <div style="border-top: 1px solid #e5e5ea; padding-top: 20px;">
                            <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 15px;">Upload Text File</h3>
                            <p style="font-size: 15px; color: #8e8e93; margin-bottom: 15px;">
                                Upload a .txt file with one contractor per line:<br>
                                Format: <strong>Name, Email, Phone, Trade1, Trade2</strong><br>
                                Example: <em>John Smith, john@email.com, 0412345678, Carpenter, Painter</em>
                            </p>
                            <input type="file" id="contractor-text-upload" accept=".txt" style="display: none;" onchange="handleContractorTextUpload(event)">
                            <button class="btn btn-secondary" style="width: 100%;" onclick="document.getElementById('contractor-text-upload').click()">
                                📄 Choose Text File
                            </button>
                        </div>

                        <div class="modal-actions" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('add-contractor-options-modal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Add Trade Modal (old single entry) -->
                <div id="add-trade-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Trade Type</span>
                            <button onclick="closeModal('add-trade-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div class="input-group">
                            <label>Trade Name:</label>
                            <input type="text" id="new-trade-name" placeholder="Carpenter">
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('add-trade-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveTrade()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Delete Trade Modal -->
                <div id="delete-trade-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Delete Trade Type</span>
                            <button onclick="closeModal('delete-trade-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <select id="delete-trade-select" style="width: 100%; padding: 10px; margin-bottom: 20px;">
                            <option value="">Select trade to delete...</option>
                            ${db.getTrades().map(t => 
                                `<option value="${t.id}">${t.name}${t.code ? ' - ' + t.code : ''}</option>`
                            ).join('')}
                        </select>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('delete-trade-modal')">Cancel</button>
                            <button class="btn btn-danger" onclick="confirmDeleteTrade()">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Hide Trade Modal -->
                <div id="hide-trade-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Hide Trade Type</span>
                            <button onclick="closeModal('hide-trade-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <p style="font-size: 14px; color: #8e8e93; margin-bottom: 15px;">
                            Hidden trades won't appear in lists but contractors can still be assigned to them.
                        </p>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                            ${db.getTrades(false).sort((a, b) => {
                                const codeA = parseInt(a.code) || 0;
                                const codeB = parseInt(b.code) || 0;
                                return codeA - codeB;
                            }).map(t => `
                                <div style="padding: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;">
                                        <input type="checkbox" class="hide-trade-checkbox" value="${t.id}" style="width: 20px; height: 20px;">
                                        <span style="font-size: 14px;">${t.name}</span>
                                    </label>
                                    <span style="font-size: 13px; color: #8e8e93; font-weight: 600;">${t.code || ''}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('hide-trade-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmHideTrades()">Hide Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Unhide Trade Modal -->
                <div id="unhide-trade-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Unhide Trade Type</span>
                            <button onclick="closeModal('unhide-trade-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <p style="font-size: 14px; color: #8e8e93; margin-bottom: 15px;">
                            Select trades to make visible again in lists.
                        </p>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                            ${(() => {
                                const hiddenTrades = db.getTrades().filter(t => t.hidden).sort((a, b) => {
                                    const codeA = parseInt(a.code) || 0;
                                    const codeB = parseInt(b.code) || 0;
                                    return codeA - codeB;
                                });
                                
                                if (hiddenTrades.length === 0) {
                                    return '<div style="text-align: center; padding: 20px; color: #8e8e93;">No hidden trades</div>';
                                }
                                
                                return hiddenTrades.map(t => `
                                    <div style="padding: 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;">
                                            <input type="checkbox" class="unhide-trade-checkbox" value="${t.id}" style="width: 20px; height: 20px;">
                                            <span style="font-size: 14px;">${t.name}</span>
                                        </label>
                                        <span style="font-size: 13px; color: #8e8e93; font-weight: 600;">${t.code || ''}</span>
                                    </div>
                                `).join('');
                            })()}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('unhide-trade-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmUnhideTrades()">Unhide Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Add Contractor Modal -->
                <div id="add-contractor-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Add Contractor</span>
                            <button onclick="closeModal('add-contractor-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <div class="input-group">
                            <label>Contractor Name:</label>
                            <input type="text" id="new-contractor-name" placeholder="John Smith">
                        </div>
                        <div class="input-group">
                            <label>Email Address:</label>
                            <input type="email" id="new-contractor-email" placeholder="john@example.com">
                        </div>
                        <div class="input-group">
                            <label>Phone Number:</label>
                            <input type="tel" id="new-contractor-phone" placeholder="0412 345 678">
                        </div>
                        <div class="input-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="margin: 0;">Trades (select one or more):</label>
                                <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;" onclick="toggleTradeList()">
                                    <span id="trade-toggle-text">Hide List</span>
                                </button>
                            </div>
                            <div id="trade-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; padding: 10px;">
                                ${db.getTrades().map(t => `
                                    <div style="padding: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;">
                                            <input type="checkbox" class="trade-checkbox" value="${t.id}" style="width: 20px; height: 20px;">
                                            <span style="font-size: 15px;">${t.name}</span>
                                        </label>
                                        <span style="font-size: 14px; color: #8e8e93; font-weight: 600;">${t.code}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="font-size: 14px; color: #8e8e93; margin-top: 8px;">
                                💡 Contractors can have multiple trades
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('add-contractor-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveContractor()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Delete Contractor Modal -->
                <div id="delete-contractor-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Delete Contractor</span>
                            <button onclick="closeModal('delete-contractor-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        <select id="delete-contractor-select" style="width: 100%; padding: 10px; margin-bottom: 20px;">
                            <option value="">Select contractor to delete...</option>
                            ${db.getContractors().map(c => 
                                `<option value="${c.id}">${c.name} - ${c.trades || 'No Trade'}</option>`
                            ).join('')}
                        </select>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('delete-contractor-modal')">Cancel</button>
                            <button class="btn btn-danger" onclick="confirmDeleteContractor()">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Edit Contact Info Modal -->
                <div id="edit-contact-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Edit Contact Info</span>
                            <button onclick="closeModal('edit-contact-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <div class="input-group">
                            <label>📧 Email:</label>
                            <input type="email" id="modal-edit-email" placeholder="contractor@example.com" style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                        </div>
                        
                        <div class="input-group">
                            <label>📞 Phone:</label>
                            <input type="tel" id="modal-edit-phone" placeholder="0400 000 000" style="width: 100%; padding: 12px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 17px;">
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal('edit-contact-modal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveContactInfoFromModal()">💾 Save</button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Assign Trades Modal -->
                <div id="bulk-assign-trades-modal" class="modal">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-primary); z-index: 10; border-bottom: 2px solid #e5e5ea; padding-bottom: 15px;">
                            <span>Bulk Assign Trades to Contractors</span>
                            <button onclick="closeModal('bulk-assign-trades-modal')" style="background: none; border: none; font-size: 28px; color: #8e8e93; cursor: pointer; padding: 0; line-height: 1;">×</button>
                        </div>
                        
                        <div style="padding: 20px 0;">
                            <div style="margin-bottom: 20px; padding: 15px; background: #E3F2FD; border-radius: 8px;">
                                <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">Quick Instructions:</div>
                                <div style="font-size: 14px; color: #555; line-height: 1.6;">
                                    1. Select contractors (tick checkboxes)<br>
                                    2. Select trades to assign (tick checkboxes)<br>
                                    3. Click "Apply" to save
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Contractors Column -->
                                <div>
                                    <div style="font-size: 17px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007AFF;">
                                        Contractors
                                        <button onclick="toggleAllContractors()" style="float: right; font-size: 13px; padding: 4px 12px; background: var(--bg-secondary); border: 1px solid #c6c6c8; border-radius: 6px; cursor: pointer;">
                                            Select All
                                        </button>
                                    </div>
                                    <div id="bulk-contractors-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                                        ${db.getContractors().map(c => `
                                            <div style="display: flex; align-items: center; padding: 8px; margin-bottom: 5px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                                                <input type="checkbox" 
                                                       id="bulk-contractor-${c.id}" 
                                                       value="${c.id}"
                                                       style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                                <label for="bulk-contractor-${c.id}" style="flex: 1; cursor: pointer; font-size: 14px;">
                                                    <div style="font-weight: 600;">${c.name}</div>
                                                    <div style="font-size: 12px; color: #8e8e93;">${c.trades || 'No Trade Assigned'}</div>
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Trades Column -->
                                <div>
                                    <div style="font-size: 17px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #34C759;">
                                        Trades to Assign
                                        <button onclick="toggleAllTrades()" style="float: right; font-size: 13px; padding: 4px 12px; background: var(--bg-secondary); border: 1px solid #c6c6c8; border-radius: 6px; cursor: pointer;">
                                            Select All
                                        </button>
                                    </div>
                                    <div id="bulk-trades-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                                        ${db.getTrades().filter(t => !t.hidden).map(t => `
                                            <div style="display: flex; align-items: center; padding: 8px; margin-bottom: 5px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                                                <input type="checkbox" 
                                                       id="bulk-trade-${t.id}" 
                                                       value="${t.id}"
                                                       style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                                <label for="bulk-trade-${t.id}" style="flex: 1; cursor: pointer; font-size: 13px;">
                                                    <span style="color: var(--blue); font-weight: 600;">${t.code}</span> - ${t.name}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 25px; display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="closeModal('bulk-assign-trades-modal')" style="flex: 1;">Cancel</button>
                                <button class="btn btn-primary" onclick="applyBulkTradeAssignment()" style="flex: 2; background: #34C759; border-color: #34C759;">
                                    ✓ Apply Trade Assignments
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function saveAddress() {
            const street = document.getElementById('new-address-street').value;
            const suburb = document.getElementById('new-address-suburb').value;
            const propertyNumber = document.getElementById('new-address-prop').value;
            
            if (!street || !suburb) {
                showToast('Please fill in all required fields', true);
                return;
            }

            db.addAddress({ street, suburb, propertyNumber });
            closeModal('add-address-modal');
            showToast('Address added successfully');
            render();
        }

        function confirmDeleteAddress() {
            const id = parseInt(document.getElementById('delete-address-select').value);
            if (!id) return;

            const result = db.deleteAddress(id);
            if (result.success) {
                closeModal('delete-address-modal');
                showToast('Address deleted successfully');
                render();
            } else {
                showToast(result.message, true);
            }
        }

        function saveTrade() {
            const name = document.getElementById('new-trade-name').value;
            if (!name) {
                showToast('Please enter a trade name', true);
                return;
            }

            db.addTrade({ name });
            closeModal('add-trade-modal');
            showToast('Trade added successfully');
            render();
        }

        function confirmDeleteTrade() {
            const id = parseInt(document.getElementById('delete-trade-select').value);
            if (!id) return;

            const result = db.deleteTrade(id);
            if (result.success) {
                closeModal('delete-trade-modal');
                showToast('Trade deleted successfully');
                render();
            } else {
                showToast(result.message, true);
            }
        }

        function saveContractor() {
            const name = document.getElementById('new-contractor-name').value.trim();
            const email = document.getElementById('new-contractor-email').value.trim();
            const phone = document.getElementById('new-contractor-phone').value.trim();
            const checkedBoxes = document.querySelectorAll('.trade-checkbox:checked');
            const tradeIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            
            if (!name) {
                showToast('Please enter contractor name', true);
                return;
            }

            if (tradeIds.length === 0) {
                // Allow saving without trades, but warn user
                if (!confirm('No trades selected. Continue anyway?')) {
                    return;
                }
            }

            db.addContractor({ name, email, phone, tradeIds });
            closeModal('add-contractor-modal');
            showToast(`Contractor added${tradeIds.length > 0 ? ' with ' + tradeIds.length + ' trade(s)' : ' (no trades assigned)'}`);
            
            // Clear form
            document.getElementById('new-contractor-name').value = '';
            document.getElementById('new-contractor-email').value = '';
            document.getElementById('new-contractor-phone').value = '';
            document.querySelectorAll('.trade-checkbox').forEach(cb => cb.checked = false);
            
            render();
        }

        function toggleTradeList() {
            const container = document.getElementById('trade-list-container');
            const toggleText = document.getElementById('trade-toggle-text');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleText.textContent = 'Hide List';
            } else {
                container.style.display = 'none';
                toggleText.textContent = 'Show List';
            }
        }

        function confirmDeleteContractor() {
            const id = parseInt(document.getElementById('delete-contractor-select').value);
            if (!id) return;

            const result = db.deleteContractor(id);
            if (result.success) {
                closeModal('delete-contractor-modal');
                showToast('Contractor deleted successfully');
                render();
            } else {
                showToast(result.message, true);
            }
        }

        function openBulkAssignTrades() {
            openModal('bulk-assign-trades-modal');
        }

        function toggleAllContractors() {
            const checkboxes = document.querySelectorAll('[id^="bulk-contractor-"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function toggleAllTrades() {
            const checkboxes = document.querySelectorAll('[id^="bulk-trade-"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function applyBulkTradeAssignment() {
            // Get selected contractors
            const contractorCheckboxes = document.querySelectorAll('[id^="bulk-contractor-"]:checked');
            const selectedContractorIds = Array.from(contractorCheckboxes).map(cb => parseInt(cb.value));

            // Get selected trades
            const tradeCheckboxes = document.querySelectorAll('[id^="bulk-trade-"]:checked');
            const selectedTradeIds = Array.from(tradeCheckboxes).map(cb => parseInt(cb.value));

            if (selectedContractorIds.length === 0) {
                showToast('Please select at least one contractor', true);
                return;
            }

            if (selectedTradeIds.length === 0) {
                showToast('Please select at least one trade', true);
                return;
            }

            // Apply trades to contractors
            let updatedCount = 0;
            selectedContractorIds.forEach(contractorId => {
                const contractor = db.getContractor(contractorId);
                if (contractor) {
                    // Merge new trades with existing ones (no duplicates)
                    const existingTradeIds = contractor.tradeIds || [];
                    const mergedTradeIds = [...new Set([...existingTradeIds, ...selectedTradeIds])];
                    
                    // Update contractor
                    contractor.tradeIds = mergedTradeIds;
                    
                    // Build trades string
                    const trades = db.getTrades()
                        .filter(t => mergedTradeIds.includes(t.id))
                        .map(t => t.name)
                        .join(', ');
                    contractor.trades = trades;
                    
                    updatedCount++;
                }
            });

            // Save to database
            db.save();

            closeModal('bulk-assign-trades-modal');
            showToast(`✓ Assigned trades to ${updatedCount} contractor(s)`);
            render();
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('Excel import feature - requires XLSX library integration');
            // In a production app, use SheetJS (xlsx) library to parse Excel files
        }

        // Multi-select handlers
        function toggleContractor(id) {
            const index = state.selectedContractors.indexOf(id);
            if (index > -1) {
                state.selectedContractors.splice(index, 1);
            } else {
                if (state.selectedContractors.length < 3) {
                    state.selectedContractors.push(id);
                }
            }
            renderMultiSelects();
        }

        function renderMultiSelects() {
            const contractorsContainer = document.getElementById('multi-contractors');
            const contractors = db.getContractors().slice(0, 6); // Show first 6
            
            contractorsContainer.innerHTML = contractors.map(c => `
                <div class="multi-select-item ${state.selectedContractors.includes(c.id) ? 'selected' : ''}"
                     onclick="toggleContractor(${c.id})">
                    ${c.name}
                </div>
            `).join('');

            const tradesContainer = document.getElementById('multi-trades');
            const trades = db.getTrades().slice(0, 6);
            
            tradesContainer.innerHTML = trades.map(t => `
                <div class="multi-select-item">
                    ${t.name}
                </div>
            `).join('');
        }

        // Main render function
        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            switch(state.currentView) {
                case 'home':
                    content = renderHomeView();
                    break;
                case 'view-defects-address':
                    content = renderViewDefectsAddress(state.filters.addressId);
                    break;
                case 'view-defects-contractor':
                    content = renderViewDefectsContractor(state.filters.contractorId);
                    break;
                case 'view-defects-trade':
                    content = renderViewDefectsTrade(state.filters);
                    break;
                case 'add-defects-address':
                    content = renderAddDefectsAddress(state.filters.addressId);
                    break;
                case 'add-defects-contractor':
                    content = renderAddDefectsContractor(state.filters.contractorId);
                    break;
                case 'view-multiple-contractors':
                    content = renderMultipleContractorsView(state.filters.contractorIds);
                    break;
                case 'view-all-defects':
                    content = renderAllDefectsView();
                    break;
                case 'manage':
                    content = renderManageScreen();
                    break;
            }

            app.innerHTML = `
                ${content}
                ${createModals()}
            `;

            if (state.currentView === 'home') {
                // No need for multi-select rendering in new design
            }
        }

        function reloadContractorTrades() {
            if (!confirm('Update all contractors with their assigned trades from the template?\n\nThis will:\n✅ Keep all your addresses and defects\n✅ Update contractor trade assignments only\n\nContinue?')) {
                return;
            }
            
            showToast('Updating contractor trades...');
            
            // Force reload from HTML template by clearing and reinitializing
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function resetDatabase() {
            if (!confirm('⚠️ WARNING: This will delete ALL data (addresses, contractors, defects, trades) and reload the 105 construction trades. Are you sure?')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Continue?')) {
                return;
            }
            
            // Clear localStorage
            localStorage.removeItem('defectTrackerData');
            
            showToast('Database reset complete! Reloading...');
            
            // Reload the page to reinitialize
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function exportAllData() {
            const data = db.data;
            const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const filename = `DefectTracker_Backup_${timestamp}.json`;
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Backup saved as ${filename}`);
        }

        function handleBackupImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.addresses || !data.contractors || !data.trades || !data.defects) {
                        showToast('Invalid backup file format', true);
                        return;
                    }
                    
                    // Confirm before importing
                    if (!confirm(`Import backup? This will replace all current data.\n\nBackup contains:\n- ${data.addresses.length} addresses\n- ${data.contractors.length} contractors\n- ${data.trades.length} trades\n- ${data.defects.length} defects`)) {
                        return;
                    }
                    
                    // Import the data
                    localStorage.setItem('defectTrackerDB', JSON.stringify(data));
                    
                    showToast('Backup imported successfully! Reloading...');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } catch (err) {
                    showToast('Failed to import backup: Invalid JSON file', true);
                    console.error(err);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function confirmHideTrades() {
            const checkedBoxes = document.querySelectorAll('.hide-trade-checkbox:checked');
            const tradeIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            
            if (tradeIds.length === 0) {
                showToast('Please select at least one trade to hide', true);
                return;
            }

            tradeIds.forEach(id => {
                db.hideTradeById(id);
            });

            closeModal('hide-trade-modal');
            showToast(`${tradeIds.length} trade(s) hidden successfully`);
            render();
        }

        function confirmUnhideTrades() {
            const checkedBoxes = document.querySelectorAll('.unhide-trade-checkbox:checked');
            const tradeIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            
            if (tradeIds.length === 0) {
                showToast('Please select at least one trade to unhide', true);
                return;
            }

            tradeIds.forEach(id => {
                db.unhideTradeById(id);
            });

            closeModal('unhide-trade-modal');
            showToast(`${tradeIds.length} trade(s) unhidden successfully`);
            render();
        }

        function callContractor(phone, event) {
            event.stopPropagation(); // Prevent clicking through to contractor view
            
            // Clean phone number (remove spaces)
            const cleanPhone = phone.replace(/\s/g, '');
            
            // Use tel: protocol to trigger phone call
            window.location.href = `tel:${cleanPhone}`;
        }

        function emailContractor(email, name, event) {
            event.stopPropagation(); // Prevent clicking through to contractor view
            
            // Create mailto link with subject
            const subject = encodeURIComponent(`Defect List - ${name}`);
            window.location.href = `mailto:${email}?subject=${subject}`;
        }

        // Dark Mode Functions
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            render(); // Re-render to update button states
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // Initialize app
        loadTheme();
        render();
    </script>
</body>
</html>
